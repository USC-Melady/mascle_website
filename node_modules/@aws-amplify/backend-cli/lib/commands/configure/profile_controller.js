import { DEFAULT_PROFILE, getHomeDir, loadSharedConfigFiles, } from '@smithy/shared-ini-file-loader';
import { fromIni } from '@aws-sdk/credential-providers';
import { EOL } from 'os';
import _fs from 'fs/promises';
import path from 'path';
import { existsSync } from 'fs';
import { AmplifyUserError } from '@aws-amplify/platform-core';
/**
 * Manages AWS profiles.
 */
export class ProfileController {
    fs;
    /**
     * constructor
     */
    constructor(fs = _fs) {
        this.fs = fs;
    }
    /**
     * Return true if the provided profile exists in the aws config and/or credential file.
     */
    profileExists = async (profile) => {
        const profileData = await loadSharedConfigFiles({
            ignoreCache: true,
        });
        return (profileData.configFile?.[profile] !== undefined ||
            profileData.credentialsFile?.[profile] !== undefined);
    };
    /**
     * Appends a profile to AWS config and credential files.
     */
    createOrAppendAWSFiles = async (options) => {
        await this.createOrAppendAWSConfigFile(options);
        await this.createOrAppendAWSCredentialFile(options);
    };
    createOrAppendAWSConfigFile = async (options) => {
        const filePath = process.env.AWS_CONFIG_FILE ?? path.join(getHomeDir(), '.aws', 'config');
        const dirName = path.dirname(filePath);
        if (!existsSync(dirName)) {
            await this.fs.mkdir(dirName, { recursive: true });
        }
        const fileEndsWithEOL = await this.isFileEndsWithEOL(filePath);
        let configData = fileEndsWithEOL ? '' : EOL;
        configData +=
            options.profile === DEFAULT_PROFILE
                ? `[${options.profile}]${EOL}`
                : `[profile ${options.profile}]${EOL}`;
        configData += `region = ${options.region}${EOL}`;
        try {
            await this.fs.appendFile(filePath, configData, { mode: '600' });
        }
        catch (err) {
            const error = err;
            if (error.message.includes('EACCES')) {
                throw new AmplifyUserError('PermissionsError', {
                    message: `You do not have the permissions to write to this file: ${filePath}`,
                    resolution: `Ensure that you have the right permissions to write to ${filePath}.`,
                }, error);
            }
            else {
                throw error;
            }
        }
        // validate after write. It is to ensure this function is compatible with the current AWS format.
        const profileData = await loadSharedConfigFiles({
            ignoreCache: true,
        });
        const retrievedRegion = profileData.configFile?.[options.profile]?.region;
        if (retrievedRegion !== options.region) {
            throw new Error(`Failed to configure the AWS config file`);
        }
    };
    createOrAppendAWSCredentialFile = async (options) => {
        const filePath = process.env.AWS_SHARED_CREDENTIALS_FILE ??
            path.join(getHomeDir(), '.aws', 'credentials');
        const dirName = path.dirname(filePath);
        if (!existsSync(dirName)) {
            await this.fs.mkdir(dirName, { recursive: true });
        }
        const fileEndsWithEOL = await this.isFileEndsWithEOL(filePath);
        let credentialData = fileEndsWithEOL ? '' : EOL;
        credentialData += `[${options.profile}]${EOL}`;
        credentialData += `aws_access_key_id = ${options.accessKeyId}${EOL}`;
        credentialData += `aws_secret_access_key = ${options.secretAccessKey}${EOL}`;
        await this.fs.appendFile(filePath, credentialData, { mode: '600' });
        // validate after write. It is to ensure this function is compatible with the current AWS format.
        const provider = fromIni({
            profile: options.profile,
            ignoreCache: true,
        });
        const retrievedCredentials = await provider();
        if (retrievedCredentials.accessKeyId !== options.accessKeyId ||
            retrievedCredentials.secretAccessKey !== options.secretAccessKey ||
            retrievedCredentials.sessionToken) {
            throw new Error(`Failed to configure the AWS credentials file`);
        }
    };
    isFileEndsWithEOL = async (filePath) => {
        try {
            const data = await this.fs.readFile(filePath, 'utf-8');
            return data.length > 0 && data.slice(-EOL.length) === EOL;
        }
        catch (err) {
            const error = err;
            if (error.message.includes('ENOENT')) {
                // file doesn't exists
                return true;
            }
            if (error.message.includes('EACCES')) {
                throw new AmplifyUserError('PermissionsError', {
                    message: `You do not have the permissions to read this file: ${filePath}.`,
                    resolution: `Ensure that you have the right permissions to read from ${filePath}.`,
                }, error);
            }
            else {
                throw err;
            }
        }
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvZmlsZV9jb250cm9sbGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2NvbW1hbmRzL2NvbmZpZ3VyZS9wcm9maWxlX2NvbnRyb2xsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNMLGVBQWUsRUFDZixVQUFVLEVBQ1YscUJBQXFCLEdBQ3RCLE1BQU0sZ0NBQWdDLENBQUM7QUFDeEMsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLCtCQUErQixDQUFDO0FBQ3hELE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxJQUFJLENBQUM7QUFDekIsT0FBTyxHQUFHLE1BQU0sYUFBYSxDQUFDO0FBQzlCLE9BQU8sSUFBSSxNQUFNLE1BQU0sQ0FBQztBQUN4QixPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sSUFBSSxDQUFDO0FBQ2hDLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBd0I5RDs7R0FFRztBQUNILE1BQU0sT0FBTyxpQkFBaUI7SUFJQztJQUg3Qjs7T0FFRztJQUNILFlBQTZCLEtBQUssR0FBRztRQUFSLE9BQUUsR0FBRixFQUFFLENBQU07SUFBRyxDQUFDO0lBQ3pDOztPQUVHO0lBQ0gsYUFBYSxHQUFHLEtBQUssRUFBRSxPQUFlLEVBQW9CLEVBQUU7UUFDMUQsTUFBTSxXQUFXLEdBQUcsTUFBTSxxQkFBcUIsQ0FBQztZQUM5QyxXQUFXLEVBQUUsSUFBSTtTQUNsQixDQUFDLENBQUM7UUFFSCxPQUFPLENBQ0wsV0FBVyxDQUFDLFVBQVUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxLQUFLLFNBQVM7WUFDL0MsV0FBVyxDQUFDLGVBQWUsRUFBRSxDQUFDLE9BQU8sQ0FBQyxLQUFLLFNBQVMsQ0FDckQsQ0FBQztJQUNKLENBQUMsQ0FBQztJQUVGOztPQUVHO0lBQ0gsc0JBQXNCLEdBQUcsS0FBSyxFQUFFLE9BQXVCLEVBQUUsRUFBRTtRQUN6RCxNQUFNLElBQUksQ0FBQywyQkFB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SUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsS0FBSyxHQUFHLENBQUM7U0FDM0Q7UUFBQyxPQUFPLEdBQUcsRUFBRTtZQUNaLE1BQU0sS0FBSyxHQUFHLEdBQVksQ0FBQztZQUMzQixJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxFQUFFO2dCQUNwQyxzQkFBc0I7Z0JBQ3RCLE9BQU8sSUFBSSxDQUFDO2FBQ2I7WUFDRCxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxFQUFFO2dCQUNwQyxNQUFNLElBQUksZ0JBQWdCLENBQ3hCLGtCQUFrQixFQUNsQjtvQkFDRSxPQUFPLEVBQUUsc0RBQXNELFFBQVEsR0FBRztvQkFDMUUsVUFBVSxFQUFFLDJEQUEyRCxRQUFRLEdBQUc7aUJBQ25GLEVBQ0QsS0FBSyxDQUNOLENBQUM7YUFDSDtpQkFBTTtnQkFDTCxNQUFNLEdBQUcsQ0FBQzthQUNYO1NBQ0Y7SUFDSCxDQUFDLENBQUM7Q0FDSCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIERFRkFVTFRfUFJPRklMRSxcbiAgZ2V0SG9tZURpcixcbiAgbG9hZFNoYXJlZENvbmZpZ0ZpbGVzLFxufSBmcm9tICdAc21pdGh5L3NoYXJlZC1pbmktZmlsZS1sb2FkZXInO1xuaW1wb3J0IHsgZnJvbUluaSB9IGZyb20gJ0Bhd3Mtc2RrL2NyZWRlbnRpYWwtcHJvdmlkZXJzJztcbmltcG9ydCB7IEVPTCB9IGZyb20gJ29zJztcbmltcG9ydCBfZnMgZnJvbSAnZnMvcHJvbWlzZXMnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBleGlzdHNTeW5jIH0gZnJvbSAnZnMnO1xuaW1wb3J0IHsgQW1wbGlmeVVzZXJFcnJvciB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbGF0Zm9ybS1jb3JlJztcblxuLyoqXG4gKiBPcHRpb25zIGZvciB0aGUgcHJvZmlsZSBjb25maWd1cmF0aW9uLlxuICovXG50eXBlIENvbmZpZ1Byb2ZpbGVPcHRpb25zID0ge1xuICBwcm9maWxlOiBzdHJpbmc7XG4gIHJlZ2lvbjogc3RyaW5nO1xufTtcblxuLyoqXG4gKiBPcHRpb25zIGZvciB0aGUgcHJvZmlsZSBjcmVkZW50aWFsLlxuICovXG50eXBlIENyZWRlbnRpYWxQcm9maWxlT3B0aW9ucyA9IHtcbiAgcHJvZmlsZTogc3RyaW5nO1xuICBhY2Nlc3NLZXlJZDogc3RyaW5nO1xuICBzZWNyZXRBY2Nlc3NLZXk6IHN0cmluZztcbn07XG5cbi8qKlxuICogT3B0aW9ucyBmb3IgdGhlIHByb2ZpbGUgY29uZmlndXJhdGlvbiBhbmQgY3JlZGVudGlhbC5cbiAqL1xuZXhwb3J0IHR5cGUgUHJvZmlsZU9wdGlvbnMgPSBDb25maWdQcm9maWxlT3B0aW9ucyAmIENyZWRlbnRpYWxQcm9maWxlT3B0aW9ucztcblxuLyoqXG4gKiBNYW5hZ2VzIEFXUyBwcm9maWxlcy5cbiAqL1xuZXhwb3J0IGNsYXNzIFByb2ZpbGVDb250cm9sbGVyIHtcbiAgLyoqXG4gICAqIGNvbnN0cnVjdG9yXG4gICAqL1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IGZzID0gX2ZzKSB7fVxuICAvKipcbiAgICogUmV0dXJuIHRydWUgaWYgdGhlIHByb3ZpZGVkIHByb2ZpbGUgZXhpc3RzIGluIHRoZSBhd3MgY29uZmlnIGFuZC9vciBjcmVkZW50aWFsIGZpbGUuXG4gICAqL1xuICBwcm9maWxlRXhpc3RzID0gYXN5bmMgKHByb2ZpbGU6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4gPT4ge1xuICAgIGNvbnN0IHByb2ZpbGVEYXRhID0gYXdhaXQgbG9hZFNoYXJlZENvbmZpZ0ZpbGVzKHtcbiAgICAgIGlnbm9yZUNhY2hlOiB0cnVlLFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIChcbiAgICAgIHByb2ZpbGVEYXRhLmNvbmZpZ0ZpbGU/Lltwcm9maWxlXSAhPT0gdW5kZWZpbmVkIHx8XG4gICAgICBwcm9maWxlRGF0YS5jcmVkZW50aWFsc0ZpbGU/Lltwcm9maWxlXSAhPT0gdW5kZWZpbmVkXG4gICAgKTtcbiAgfTtcblxuICAvKipcbiAgICogQXBwZW5kcyBhIHByb2ZpbGUgdG8gQVdTIGNvbmZpZyBhbmQgY3JlZGVudGlhbCBmaWxlcy5cbiAgICovXG4gIGNyZWF0ZU9yQXBwZW5kQVdTRmlsZXMgPSBhc3luYyAob3B0aW9uczogUHJvZmlsZU9wdGlvbnMpID0+IHtcbiAgICBhd2FpdCB0aGlzLmNyZWF0ZU9yQXBwZW5kQVdTQ29uZmlnRmlsZShvcHRpb25zKTtcbiAgICBhd2FpdCB0aGlzLmNyZWF0ZU9yQXBwZW5kQVdTQ3JlZGVudGlhbEZpbGUob3B0aW9ucyk7XG4gIH07XG5cbiAgcHJpdmF0ZSBjcmVhdGVPckFwcGVuZEFXU0NvbmZpZ0ZpbGUgPSBhc3luYyAoXG4gICAgb3B0aW9uczogQ29uZmlnUHJvZmlsZU9wdGlvbnMsXG4gICkgPT4ge1xuICAgIGNvbnN0IGZpbGVQYXRoID1cbiAgICAgIHByb2Nlc3MuZW52LkFXU19DT05GSUdfRklMRSA/PyBwYXRoLmpvaW4oZ2V0SG9tZURpcigpLCAnLmF3cycsICdjb25maWcnKTtcblxuICAgIGNvbnN0IGRpck5hbWUgPSBwYXRoLmRpcm5hbWUoZmlsZVBhdGgpO1xuICAgIGlmICghZXhpc3RzU3luYyhkaXJOYW1lKSkge1xuICAgICAgYXdhaXQgdGhpcy5mcy5ta2RpcihkaXJOYW1lLCB7IHJlY3Vyc2l2ZTogdHJ1ZSB9KTtcbiAgICB9XG5cbiAgICBjb25zdCBmaWxlRW5kc1dpdGhFT0wgPSBhd2FpdCB0aGlzLmlzRmlsZUVuZHNXaXRoRU9MKGZpbGVQYXRoKTtcbiAgICBsZXQgY29uZmlnRGF0YSA9IGZpbGVFbmRzV2l0aEVPTCA/ICcnIDogRU9MO1xuXG4gICAgY29uZmlnRGF0YSArPVxuICAgICAgb3B0aW9ucy5wcm9maWxlID09PSBERUZBVUxUX1BST0ZJTEVcbiAgICAgICAgPyBgWyR7b3B0aW9ucy5wcm9maWxlfV0ke0VPTH1gXG4gICAgICAgIDogYFtwcm9maWxlICR7b3B0aW9ucy5wcm9maWxlfV0ke0VPTH1gO1xuICAgIGNvbmZpZ0RhdGEgKz0gYHJlZ2lvbiA9ICR7b3B0aW9ucy5yZWdpb259JHtFT0x9YDtcblxuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLmZzLmFwcGVuZEZpbGUoZmlsZVBhdGgsIGNvbmZpZ0RhdGEsIHsgbW9kZTogJzYwMCcgfSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBjb25zdCBlcnJvciA9IGVyciBhcyBFcnJvcjtcbiAgICAgIGlmIChlcnJvci5tZXNzYWdlLmluY2x1ZGVzKCdFQUNDRVMnKSkge1xuICAgICAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcihcbiAgICAgICAgICAnUGVybWlzc2lvbnNFcnJvcicsXG4gICAgICAgICAge1xuICAgICAgICAgICAgbWVzc2FnZTogYFlvdSBkbyBub3QgaGF2ZSB0aGUgcGVybWlzc2lvbnMgdG8gd3JpdGUgdG8gdGhpcyBmaWxlOiAke2ZpbGVQYXRofWAsXG4gICAgICAgICAgICByZXNvbHV0aW9uOiBgRW5zdXJlIHRoYXQgeW91IGhhdmUgdGhlIHJpZ2h0IHBlcm1pc3Npb25zIHRvIHdyaXRlIHRvICR7ZmlsZVBhdGh9LmAsXG4gICAgICAgICAgfSxcbiAgICAgICAgICBlcnJvcixcbiAgICAgICAgKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IGVycm9yO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIHZhbGlkYXRlIGFmdGVyIHdyaXRlLiBJdCBpcyB0byBlbnN1cmUgdGhpcyBmdW5jdGlvbiBpcyBjb21wYXRpYmxlIHdpdGggdGhlIGN1cnJlbnQgQVdTIGZvcm1hdC5cbiAgICBjb25zdCBwcm9maWxlRGF0YSA9IGF3YWl0IGxvYWRTaGFyZWRDb25maWdGaWxlcyh7XG4gICAgICBpZ25vcmVDYWNoZTogdHJ1ZSxcbiAgICB9KTtcbiAgICBjb25zdCByZXRyaWV2ZWRSZWdpb24gPSBwcm9maWxlRGF0YS5jb25maWdGaWxlPy5bb3B0aW9ucy5wcm9maWxlXT8ucmVnaW9uO1xuICAgIGlmIChyZXRyaWV2ZWRSZWdpb24gIT09IG9wdGlvbnMucmVnaW9uKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEZhaWxlZCB0byBjb25maWd1cmUgdGhlIEFXUyBjb25maWcgZmlsZWApO1xuICAgIH1cbiAgfTtcblxuICBwcml2YXRlIGNyZWF0ZU9yQXBwZW5kQVdTQ3JlZGVudGlhbEZpbGUgPSBhc3luYyAoXG4gICAgb3B0aW9uczogQ3JlZGVudGlhbFByb2ZpbGVPcHRpb25zLFxuICApID0+IHtcbiAgICBjb25zdCBmaWxlUGF0aCA9XG4gICAgICBwcm9jZXNzLmVudi5BV1NfU0hBUkVEX0NSRURFTlRJQUxTX0ZJTEUgPz9cbiAgICAgIHBhdGguam9pbihnZXRIb21lRGlyKCksICcuYXdzJywgJ2NyZWRlbnRpYWxzJyk7XG5cbiAgICBjb25zdCBkaXJOYW1lID0gcGF0aC5kaXJuYW1lKGZpbGVQYXRoKTtcbiAgICBpZiAoIWV4aXN0c1N5bmMoZGlyTmFtZSkpIHtcbiAgICAgIGF3YWl0IHRoaXMuZnMubWtkaXIoZGlyTmFtZSwgeyByZWN1cnNpdmU6IHRydWUgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgZmlsZUVuZHNXaXRoRU9MID0gYXdhaXQgdGhpcy5pc0ZpbGVFbmRzV2l0aEVPTChmaWxlUGF0aCk7XG4gICAgbGV0IGNyZWRlbnRpYWxEYXRhID0gZmlsZUVuZHNXaXRoRU9MID8gJycgOiBFT0w7XG5cbiAgICBjcmVkZW50aWFsRGF0YSArPSBgWyR7b3B0aW9ucy5wcm9maWxlfV0ke0VPTH1gO1xuICAgIGNyZWRlbnRpYWxEYXRhICs9IGBhd3NfYWNjZXNzX2tleV9pZCA9ICR7b3B0aW9ucy5hY2Nlc3NLZXlJZH0ke0VPTH1gO1xuICAgIGNyZWRlbnRpYWxEYXRhICs9IGBhd3Nfc2VjcmV0X2FjY2Vzc19rZXkgPSAke29wdGlvbnMuc2VjcmV0QWNjZXNzS2V5fSR7RU9MfWA7XG5cbiAgICBhd2FpdCB0aGlzLmZzLmFwcGVuZEZpbGUoZmlsZVBhdGgsIGNyZWRlbnRpYWxEYXRhLCB7IG1vZGU6ICc2MDAnIH0pO1xuXG4gICAgLy8gdmFsaWRhdGUgYWZ0ZXIgd3JpdGUuIEl0IGlzIHRvIGVuc3VyZSB0aGlzIGZ1bmN0aW9uIGlzIGNvbXBhdGlibGUgd2l0aCB0aGUgY3VycmVudCBBV1MgZm9ybWF0LlxuICAgIGNvbnN0IHByb3ZpZGVyID0gZnJvbUluaSh7XG4gICAgICBwcm9maWxlOiBvcHRpb25zLnByb2ZpbGUsXG4gICAgICBpZ25vcmVDYWNoZTogdHJ1ZSxcbiAgICB9KTtcbiAgICBjb25zdCByZXRyaWV2ZWRDcmVkZW50aWFscyA9IGF3YWl0IHByb3ZpZGVyKCk7XG4gICAgaWYgKFxuICAgICAgcmV0cmlldmVkQ3JlZGVudGlhbHMuYWNjZXNzS2V5SWQgIT09IG9wdGlvbnMuYWNjZXNzS2V5SWQgfHxcbiAgICAgIHJldHJpZXZlZENyZWRlbnRpYWxzLnNlY3JldEFjY2Vzc0tleSAhPT0gb3B0aW9ucy5zZWNyZXRBY2Nlc3NLZXkgfHxcbiAgICAgIHJldHJpZXZlZENyZWRlbnRpYWxzLnNlc3Npb25Ub2tlblxuICAgICkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBGYWlsZWQgdG8gY29uZmlndXJlIHRoZSBBV1MgY3JlZGVudGlhbHMgZmlsZWApO1xuICAgIH1cbiAgfTtcblxuICBwcml2YXRlIGlzRmlsZUVuZHNXaXRoRU9MID0gYXN5bmMgKGZpbGVQYXRoOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+ID0+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgZGF0YSA9IGF3YWl0IHRoaXMuZnMucmVhZEZpbGUoZmlsZVBhdGgsICd1dGYtOCcpO1xuICAgICAgcmV0dXJuIGRhdGEubGVuZ3RoID4gMCAmJiBkYXRhLnNsaWNlKC1FT0wubGVuZ3RoKSA9PT0gRU9MO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgY29uc3QgZXJyb3IgPSBlcnIgYXMgRXJyb3I7XG4gICAgICBpZiAoZXJyb3IubWVzc2FnZS5pbmNsdWRlcygnRU5PRU5UJykpIHtcbiAgICAgICAgLy8gZmlsZSBkb2Vzbid0IGV4aXN0c1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cbiAgICAgIGlmIChlcnJvci5tZXNzYWdlLmluY2x1ZGVzKCdFQUNDRVMnKSkge1xuICAgICAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcihcbiAgICAgICAgICAnUGVybWlzc2lvbnNFcnJvcicsXG4gICAgICAgICAge1xuICAgICAgICAgICAgbWVzc2FnZTogYFlvdSBkbyBub3QgaGF2ZSB0aGUgcGVybWlzc2lvbnMgdG8gcmVhZCB0aGlzIGZpbGU6ICR7ZmlsZVBhdGh9LmAsXG4gICAgICAgICAgICByZXNvbHV0aW9uOiBgRW5zdXJlIHRoYXQgeW91IGhhdmUgdGhlIHJpZ2h0IHBlcm1pc3Npb25zIHRvIHJlYWQgZnJvbSAke2ZpbGVQYXRofS5gLFxuICAgICAgICAgIH0sXG4gICAgICAgICAgZXJyb3IsXG4gICAgICAgICk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBlcnI7XG4gICAgICB9XG4gICAgfVxuICB9O1xufVxuIl19