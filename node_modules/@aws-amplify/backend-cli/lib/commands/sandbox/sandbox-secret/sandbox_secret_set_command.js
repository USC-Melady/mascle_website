import { AmplifyPrompter, printer } from '@aws-amplify/cli-core';
import { once } from 'events';
import { AmplifyUserError } from '@aws-amplify/platform-core';
/**
 * Command to set sandbox secret.
 */
export class SandboxSecretSetCommand {
    sandboxIdResolver;
    secretClient;
    readStream;
    /**
     * @inheritDoc
     */
    command;
    /**
     * @inheritDoc
     */
    describe;
    /**
     * Set sandbox secret command.
     */
    constructor(sandboxIdResolver, secretClient, readStream = process.stdin) {
        this.sandboxIdResolver = sandboxIdResolver;
        this.secretClient = secretClient;
        this.readStream = readStream;
        this.command = 'set <secret-name>';
        this.describe = 'Set a sandbox secret';
    }
    /**
     * @inheritDoc
     */
    handler = async (args) => {
        const secretValue = await this.readSecretValue();
        const secretIdentifier = await this.secretClient.setSecret(await this.sandboxIdResolver.resolve(args.identifier), args.secretName, secretValue);
        printer.print(`Successfully created version ${secretIdentifier.version} of secret ${secretIdentifier.name}`);
    };
    /**
     * @inheritDoc
     */
    builder = (yargs) => {
        return yargs
            .positional('secret-name', {
            describe: 'Name of the secret to set',
            type: 'string',
            demandOption: true,
        })
            .check(async (argv) => {
            if (argv['secret-name']) {
                const secretNameRegex = /^[a-zA-Z0-9_.-]+$/;
                if (!argv['secret-name'].match(secretNameRegex)) {
                    throw new AmplifyUserError('InvalidCommandInputError', {
                        message: `Invalid secret name provided: ${argv['secret-name']}`,
                        resolution: 'Use a secret name that matches [a-zA-Z0-9_.-]+',
                    });
                }
            }
            return true;
        });
    };
    /**
     * Prompt (or) read secret value from stdin based on terminal interactive mode
     */
    readSecretValue = async () => {
        let secretValue = '';
        if (this.readStream.isTTY) {
            // This input is for interactive mode.
            secretValue = await AmplifyPrompter.secretValue();
        }
        else {
            // This allows to accept secret value from redirected input `|` and `>`.
            this.readStream.on('readable', () => {
                const chunk = this.readStream.read();
                if (chunk !== null) {
                    secretValue += chunk;
                }
            });
            // Wait for the end of the input.
            await once(this.readStream, 'end');
        }
        return secretValue;
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2FuZGJveF9zZWNyZXRfc2V0X2NvbW1hbmQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvY29tbWFuZHMvc2FuZGJveC9zYW5kYm94LXNlY3JldC9zYW5kYm94X3NlY3JldF9zZXRfY29tbWFuZC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFHQSxPQUFPLEVBQUUsZUFBZSxFQUFFLE9BQU8sRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBR2pFLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxRQUFRLENBQUM7QUFFOUIsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFFOUQ7O0dBRUc7QUFDSCxNQUFNLE9BQU8sdUJBQXVCO0lBaUJmO0lBQ0E7SUFDQTtJQWhCbkI7O09BRUc7SUFDTSxPQUFPLENBQVM7SUFFekI7O09BRUc7SUFDTSxRQUFRLENBQVM7SUFFMUI7O09BRUc7SUFDSCxZQUNtQixpQkFBMkMsRUFDM0MsWUFBMEIsRUFDMUIsYUFBeUIsT0FBTyxDQUFDLEtBQUs7UUFGdEMsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUEwQjtRQUMzQyxpQkFBWSxHQUFaLFlBQVksQ0FBYztRQUMxQixlQUFVLEdBQVYsVUFBVSxDQUE0QjtRQUV2RCxJQUFJLENBQUMsT0FBTyxHQUFHLG1CQUFtQixDQUFDO1FBQ25DLElBQUksQ0FBQyxRQUFRLEdBQUcsc0JBQXNCLENBQUM7SUFDekMsQ0FBQztJQUVEOztPQUVHO0lBQ0gsT0FBTyxHQUFHLEtBQUssRUFDYixJQUEwRCxFQUMzQyxFQUFFO1FBQ2pCLE1BQU0sV0FBVyxHQUFHLE1BQU0sSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO1FBRWpELE1BQU0sZ0JBQWdCLEdBQUcsTUFBTSxJQUFJLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FDeEQsTUFBTSxJQUFJLENBQUMsaUJBQWlCLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsRUFDckQsSUFBSSxDQUFDLFVBQVUsRUFDZixXQUFXLENBQ1osQ0FBQztRQUNGLE9BQU8sQ0FBQyxLQUFLLENBQ1gsZ0NBQWdDLGdCQUFnQixDQUFDLE9BQU8sY0FBYyxnQkFBZ0IsQ0FBQyxJQUFJLEVBQUUsQ0FDOUYsQ0FBQztJQUNKLENBQUMsQ0FBQztJQUVGOztPQUVHO0lBQ0gsT0FBTyxHQUFHLENBQUMsS0FBVyxFQUEwQyxFQUFFO1FBQ2hFLE9BQU8sS0FBSzthQUNULFVBQVUsQ0FBQyxhQUFhLEVBQUU7WUFDekIsUUFBUSxFQUFFLDJCQUEyQjtZQUNyQyxJQUFJLEVBQUUsUUFBUTtZQUNkLFlBQVksRUFBRSxJQUFJO1NBQ25CLENBQUM7YUFDRCxLQUFLLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxFQUFFO1lBQ3BCLElBQUksSUFBSSxDQUFDLGFBQWEsQ0FBQyxFQUFFO2dCQUN2QixNQUFNLGVBQWUsR0FBRyxtQkFBbUIsQ0FBQztnQkFDNUMsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQyxLQUFLLENBQUMsZUFBZSxDQUFDLEVBQUU7b0JBQy9DLE1BQU0sSUFBSSxnQkFBZ0IsQ0FBQywwQkFBMEIsRUFBRTt3QkFDckQsT0FBTyxFQUFFLGlDQUFpQyxJQUFJLENBQUMsYUFBYSxDQUFDLEVBQUU7d0JBQy9ELFVBQVUsRUFBRSxnREFBZ0Q7cUJBQzdELENBQUMsQ0FBQztpQkFDSjthQUNGO1lBQ0QsT0FBTyxJQUFJLENBQUM7UUFDZCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUMsQ0FBQztJQUVGOztPQUVHO0lBQ0ssZUFBZSxHQUFHLEtBQUssSUFBcUIsRUFBRTtRQUNwRCxJQUFJLFdBQVcsR0FBRyxFQUFFLENBQUM7UUFDckIsSUFBSSxJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssRUFBRTtZQUN6QixzQ0FBc0M7WUFDdEMsV0FBVyxHQUFHLE1BQU0sZUFBZSxDQUFDLFdBQVcsRUFBRSxDQUFDO1NBQ25EO2FBQU07WUFDTCx3RUFBd0U7WUFDeEUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUMsVUFBVSxFQUFFLEdBQUcsRUFBRTtnQkFDbEMsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLEVBQUUsQ0FBQztnQkFDckMsSUFBSSxLQUFLLEtBQUssSUFBSSxFQUFFO29CQUNsQixXQUFXLElBQUksS0FBSyxDQUFDO2lCQUN0QjtZQUNILENBQUMsQ0FBQyxDQUFDO1lBQ0gsaUNBQWlDO1lBQ2pDLE1BQU0sSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUUsS0FBSyxDQUFDLENBQUM7U0FDcEM7UUFDRCxPQUFPLFdBQVcsQ0FBQztJQUNyQixDQUFDLENBQUM7Q0FDSCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFyZ3VtZW50c0NhbWVsQ2FzZSwgQXJndiwgQ29tbWFuZE1vZHVsZSB9IGZyb20gJ3lhcmdzJztcbmltcG9ydCB7IFNlY3JldENsaWVudCB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9iYWNrZW5kLXNlY3JldCc7XG5pbXBvcnQgeyBTYW5kYm94QmFja2VuZElkUmVzb2x2ZXIgfSBmcm9tICcuLi9zYW5kYm94X2lkX3Jlc29sdmVyLmpzJztcbmltcG9ydCB7IEFtcGxpZnlQcm9tcHRlciwgcHJpbnRlciB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9jbGktY29yZSc7XG5pbXBvcnQgeyBBcmd1bWVudHNLZWJhYkNhc2UgfSBmcm9tICcuLi8uLi8uLi9rZWJhYl9jYXNlLmpzJztcbmltcG9ydCB7IFNhbmRib3hDb21tYW5kR2xvYmFsT3B0aW9ucyB9IGZyb20gJy4uL29wdGlvbl90eXBlcy5qcyc7XG5pbXBvcnQgeyBvbmNlIH0gZnJvbSAnZXZlbnRzJztcbmltcG9ydCB7IFJlYWRTdHJlYW0gfSBmcm9tICdub2RlOnR0eSc7XG5pbXBvcnQgeyBBbXBsaWZ5VXNlckVycm9yIH0gZnJvbSAnQGF3cy1hbXBsaWZ5L3BsYXRmb3JtLWNvcmUnO1xuXG4vKipcbiAqIENvbW1hbmQgdG8gc2V0IHNhbmRib3ggc2VjcmV0LlxuICovXG5leHBvcnQgY2xhc3MgU2FuZGJveFNlY3JldFNldENvbW1hbmRcbiAgaW1wbGVtZW50cyBDb21tYW5kTW9kdWxlPG9iamVjdCwgU2VjcmV0U2V0Q29tbWFuZE9wdGlvbnNLZWJhYkNhc2U+XG57XG4gIC8qKlxuICAgKiBAaW5oZXJpdERvY1xuICAgKi9cbiAgcmVhZG9ubHkgY29tbWFuZDogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBAaW5oZXJpdERvY1xuICAgKi9cbiAgcmVhZG9ubHkgZGVzY3JpYmU6IHN0cmluZztcblxuICAvKipcbiAgICogU2V0IHNhbmRib3ggc2VjcmV0IGNvbW1hbmQuXG4gICAqL1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IHNhbmRib3hJZFJlc29sdmVyOiBTYW5kYm94QmFja2VuZElkUmVzb2x2ZXIsXG4gICAgcHJpdmF0ZSByZWFkb25seSBzZWNyZXRDbGllbnQ6IFNlY3JldENsaWVudCxcbiAgICBwcml2YXRlIHJlYWRvbmx5IHJlYWRTdHJlYW06IFJlYWRTdHJlYW0gPSBwcm9jZXNzLnN0ZGluLFxuICApIHtcbiAgICB0aGlzLmNvbW1hbmQgPSAnc2V0IDxzZWNyZXQtbmFtZT4nO1xuICAgIHRoaXMuZGVzY3JpYmUgPSAnU2V0IGEgc2FuZGJveCBzZWNyZXQnO1xuICB9XG5cbiAgLyoqXG4gICAqIEBpbmhlcml0RG9jXG4gICAqL1xuICBoYW5kbGVyID0gYXN5bmMgKFxuICAgIGFyZ3M6IEFyZ3VtZW50c0NhbWVsQ2FzZTxTZWNyZXRTZXRDb21tYW5kT3B0aW9uc0tlYmFiQ2FzZT4sXG4gICk6IFByb21pc2U8dm9pZD4gPT4ge1xuICAgIGNvbnN0IHNlY3JldFZhbHVlID0gYXdhaXQgdGhpcy5yZWFkU2VjcmV0VmFsdWUoKTtcblxuICAgIGNvbnN0IHNlY3JldElkZW50aWZpZXIgPSBhd2FpdCB0aGlzLnNlY3JldENsaWVudC5zZXRTZWNyZXQoXG4gICAgICBhd2FpdCB0aGlzLnNhbmRib3hJZFJlc29sdmVyLnJlc29sdmUoYXJncy5pZGVudGlmaWVyKSxcbiAgICAgIGFyZ3Muc2VjcmV0TmFtZSxcbiAgICAgIHNlY3JldFZhbHVlLFxuICAgICk7XG4gICAgcHJpbnRlci5wcmludChcbiAgICAgIGBTdWNjZXNzZnVsbHkgY3JlYXRlZCB2ZXJzaW9uICR7c2VjcmV0SWRlbnRpZmllci52ZXJzaW9ufSBvZiBzZWNyZXQgJHtzZWNyZXRJZGVudGlmaWVyLm5hbWV9YCxcbiAgICApO1xuICB9O1xuXG4gIC8qKlxuICAgKiBAaW5oZXJpdERvY1xuICAgKi9cbiAgYnVpbGRlciA9ICh5YXJnczogQXJndik6IEFyZ3Y8U2VjcmV0U2V0Q29tbWFuZE9wdGlvbnNLZWJhYkNhc2U+ID0+IHtcbiAgICByZXR1cm4geWFyZ3NcbiAgICAgIC5wb3NpdGlvbmFsKCdzZWNyZXQtbmFtZScsIHtcbiAgICAgICAgZGVzY3JpYmU6ICdOYW1lIG9mIHRoZSBzZWNyZXQgdG8gc2V0JyxcbiAgICAgICAgdHlwZTogJ3N0cmluZycsXG4gICAgICAgIGRlbWFuZE9wdGlvbjogdHJ1ZSxcbiAgICAgIH0pXG4gICAgICAuY2hlY2soYXN5bmMgKGFyZ3YpID0+IHtcbiAgICAgICAgaWYgKGFyZ3ZbJ3NlY3JldC1uYW1lJ10pIHtcbiAgICAgICAgICBjb25zdCBzZWNyZXROYW1lUmVnZXggPSAvXlthLXpBLVowLTlfLi1dKyQvO1xuICAgICAgICAgIGlmICghYXJndlsnc2VjcmV0LW5hbWUnXS5tYXRjaChzZWNyZXROYW1lUmVnZXgpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcignSW52YWxpZENvbW1hbmRJbnB1dEVycm9yJywge1xuICAgICAgICAgICAgICBtZXNzYWdlOiBgSW52YWxpZCBzZWNyZXQgbmFtZSBwcm92aWRlZDogJHthcmd2WydzZWNyZXQtbmFtZSddfWAsXG4gICAgICAgICAgICAgIHJlc29sdXRpb246ICdVc2UgYSBzZWNyZXQgbmFtZSB0aGF0IG1hdGNoZXMgW2EtekEtWjAtOV8uLV0rJyxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH0pO1xuICB9O1xuXG4gIC8qKlxuICAgKiBQcm9tcHQgKG9yKSByZWFkIHNlY3JldCB2YWx1ZSBmcm9tIHN0ZGluIGJhc2VkIG9uIHRlcm1pbmFsIGludGVyYWN0aXZlIG1vZGVcbiAgICovXG4gIHByaXZhdGUgcmVhZFNlY3JldFZhbHVlID0gYXN5bmMgKCk6IFByb21pc2U8c3RyaW5nPiA9PiB7XG4gICAgbGV0IHNlY3JldFZhbHVlID0gJyc7XG4gICAgaWYgKHRoaXMucmVhZFN0cmVhbS5pc1RUWSkge1xuICAgICAgLy8gVGhpcyBpbnB1dCBpcyBmb3IgaW50ZXJhY3RpdmUgbW9kZS5cbiAgICAgIHNlY3JldFZhbHVlID0gYXdhaXQgQW1wbGlmeVByb21wdGVyLnNlY3JldFZhbHVlKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIFRoaXMgYWxsb3dzIHRvIGFjY2VwdCBzZWNyZXQgdmFsdWUgZnJvbSByZWRpcmVjdGVkIGlucHV0IGB8YCBhbmQgYD5gLlxuICAgICAgdGhpcy5yZWFkU3RyZWFtLm9uKCdyZWFkYWJsZScsICgpID0+IHtcbiAgICAgICAgY29uc3QgY2h1bmsgPSB0aGlzLnJlYWRTdHJlYW0ucmVhZCgpO1xuICAgICAgICBpZiAoY2h1bmsgIT09IG51bGwpIHtcbiAgICAgICAgICBzZWNyZXRWYWx1ZSArPSBjaHVuaztcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgICAvLyBXYWl0IGZvciB0aGUgZW5kIG9mIHRoZSBpbnB1dC5cbiAgICAgIGF3YWl0IG9uY2UodGhpcy5yZWFkU3RyZWFtLCAnZW5kJyk7XG4gICAgfVxuICAgIHJldHVybiBzZWNyZXRWYWx1ZTtcbiAgfTtcbn1cblxudHlwZSBTZWNyZXRTZXRDb21tYW5kT3B0aW9uc0tlYmFiQ2FzZSA9IEFyZ3VtZW50c0tlYmFiQ2FzZTxcbiAge1xuICAgIHNlY3JldE5hbWU6IHN0cmluZztcbiAgfSAmIFNhbmRib3hDb21tYW5kR2xvYmFsT3B0aW9uc1xuPjtcbiJdfQ==