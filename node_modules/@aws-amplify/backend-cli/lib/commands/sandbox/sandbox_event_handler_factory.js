import { AmplifyError } from '@aws-amplify/platform-core';
import { format, printer } from '@aws-amplify/cli-core';
/**
 * Coordinates creation of sandbox event handlers
 */
export class SandboxEventHandlerFactory {
    getBackendIdentifier;
    getUsageDataEmitter;
    /**
     * Creates a SandboxEventHandlerFactory
     */
    constructor(getBackendIdentifier, getUsageDataEmitter) {
        this.getBackendIdentifier = getBackendIdentifier;
        this.getUsageDataEmitter = getUsageDataEmitter;
    }
    getSandboxEventHandlers = ({ sandboxIdentifier: sandboxIdentifier, clientConfigLifecycleHandler, }) => {
        return {
            successfulDeployment: [
                async (...args) => {
                    const backendIdentifier = await this.getBackendIdentifier(sandboxIdentifier);
                    const usageDataEmitter = await this.getUsageDataEmitter();
                    try {
                        await clientConfigLifecycleHandler.generateClientConfigFile(backendIdentifier);
                        if (args && args[0]) {
                            const deployResult = args[0];
                            if (deployResult && deployResult.deploymentTimes) {
                                await usageDataEmitter.emitSuccess(deployResult.deploymentTimes, { command: 'Sandbox' });
                            }
                        }
                    }
                    catch (error) {
                        // Don't crash sandbox if config cannot be generated, but print the error message
                        printer.print(`${format.error('Amplify outputs could not be generated.')} ${format.error(error)}`);
                    }
                },
            ],
            successfulDeletion: [
                async () => {
                    await clientConfigLifecycleHandler.deleteClientConfigFile();
                },
            ],
            failedDeployment: [
                async (...args) => {
                    const usageDataEmitter = await this.getUsageDataEmitter();
                    if (args.length == 0 || !args[0]) {
                        return;
                    }
                    const deployError = args[0];
                    if (deployError && AmplifyError.isAmplifyError(deployError)) {
                        await usageDataEmitter.emitFailure(deployError, {
                            command: 'Sandbox',
                        });
                    }
                    else {
                        await usageDataEmitter.emitFailure(AmplifyError.fromError(deployError), {
                            command: 'Sandbox',
                        });
                    }
                },
            ],
        };
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2FuZGJveF9ldmVudF9oYW5kbGVyX2ZhY3RvcnkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvY29tbWFuZHMvc2FuZGJveC9zYW5kYm94X2V2ZW50X2hhbmRsZXJfZmFjdG9yeS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFFQSxPQUFPLEVBQUUsWUFBWSxFQUFvQixNQUFNLDRCQUE0QixDQUFDO0FBRTVFLE9BQU8sRUFBRSxNQUFNLEVBQUUsT0FBTyxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFFeEQ7O0dBRUc7QUFDSCxNQUFNLE9BQU8sMEJBQTBCO0lBS2xCO0lBR0E7SUFQbkI7O09BRUc7SUFDSCxZQUNtQixvQkFFYyxFQUNkLG1CQUFvRDtRQUhwRCx5QkFBb0IsR0FBcEIsb0JBQW9CLENBRU47UUFDZCx3QkFBbUIsR0FBbkIsbUJBQW1CLENBQWlDO0lBQ3BFLENBQUM7SUFFSix1QkFBdUIsR0FBK0IsQ0FBQyxFQUNyRCxpQkFBaUIsRUFBRSxpQkFBaUIsRUFDcEMsNEJBQTRCLEdBQzdCLEVBQUUsRUFBRTtRQUNILE9BQU87WUFDTCxvQkFBb0IsRUFBRTtnQkFDcEIsS0FBSyxFQUFFLEdBQUcsSUFBZSxFQUFFLEVBQUU7b0JBQzNCLE1BQU0saUJBQWlCLEdBQ3JCLE1BQU0sSUFBSSxDQUFDLG9CQUFvQixDQUFDLGlCQUFpQixDQUFDLENBQUM7b0JBQ3JELE1BQU0sZ0JBQWdCLEdBQUcsTUFBTSxJQUFJLENBQUMsbUJBQW1CLEVBQUUsQ0FBQztvQkFDMUQsSUFBSTt3QkFDRixNQUFNLDRCQUE0QixDQUFDLHdCQUF3QixDQUN6RCxpQkFBaUIsQ0FDbEIsQ0FBQzt3QkFDRixJQUFJLElBQUksSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUU7NEJBQ25CLE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxDQUFDLENBQWlCLENBQUM7NEJBQzdDLElBQUksWUFBWSxJQUFJLFlBQVksQ0FBQyxlQUFlLEVBQUU7Z0NBQ2hELE1BQU0sZ0JBQWdCLENBQUMsV0FBVyxDQUNoQyxZQUFZLENBQUMsZUFBZSxFQUM1QixFQUFFLE9BQU8sRUFBRSxTQUFTLEVBQUUsQ0FDdkIsQ0FBQzs2QkFDSDt5QkFDRjtxQkFDRjtvQkFBQyxPQUFPLEtBQUssRUFBRTt3QkFDZCxpRkFBaUY7d0JBQ2pGLE9BQU8sQ0FBQyxLQUFLLENBQ1gsR0FBRyxNQUFNLENBQUMsS0FBSyxDQUNiLHlDQUF5QyxDQUMxQyxJQUFJLE1BQU0sQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FDM0IsQ0FBQztxQkFDSDtnQkFDSCxDQUFDO2FBQ0Y7WUFDRCxrQkFBa0IsRUFBRTtnQkFDbEIsS0FBSyxJQUFJLEVBQUU7b0JBQ1QsTUFBTSw0QkFBNEIsQ0FBQyxzQkFBc0IsRUFBRSxDQUFDO2dCQUM5RCxDQUFDO2FBQ0Y7WUFDRCxnQkFBZ0IsRUFBRTtnQkFDaEIsS0FBSyxFQUFFLEdBQUcsSUFBZSxFQUFFLEVBQUU7b0JBQzNCLE1BQU0sZ0JBQWdCLEdBQUcsTUFBTSxJQUFJLENBQUMsbUJBQW1CLEVBQUUsQ0FBQztvQkFDMUQsSUFBSSxJQUFJLENBQUMsTUFBTSxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRTt3QkFDaEMsT0FBTztxQkFDUjtvQkFDRCxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQzVCLElBQUksV0FBVyxJQUFJLFlBQVksQ0FBQyxjQUFjLENBQUMsV0FBVyxDQUFDLEVBQUU7d0JBQzNELE1BQU0sZ0JBQWdCLENBQUMsV0FBVyxDQUFDLFdBQVcsRUFBRTs0QkFDOUMsT0FBTyxFQUFFLFNBQVM7eUJBQ25CLENBQUMsQ0FBQztxQkFDSjt5QkFBTTt3QkFDTCxNQUFNLGdCQUFnQixDQUFDLFdBQVcsQ0FDaEMsWUFBWSxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsRUFDbkM7NEJBQ0UsT0FBTyxFQUFFLFNBQVM7eUJBQ25CLENBQ0YsQ0FBQztxQkFDSDtnQkFDSCxDQUFDO2FBQ0Y7U0FDRixDQUFDO0lBQ0osQ0FBQyxDQUFDO0NBQ0giLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTYW5kYm94RXZlbnRIYW5kbGVyQ3JlYXRvciB9IGZyb20gJy4vc2FuZGJveF9jb21tYW5kLmpzJztcbmltcG9ydCB7IEJhY2tlbmRJZGVudGlmaWVyIH0gZnJvbSAnQGF3cy1hbXBsaWZ5L3BsdWdpbi10eXBlcyc7XG5pbXBvcnQgeyBBbXBsaWZ5RXJyb3IsIFVzYWdlRGF0YUVtaXR0ZXIgfSBmcm9tICdAYXdzLWFtcGxpZnkvcGxhdGZvcm0tY29yZSc7XG5pbXBvcnQgeyBEZXBsb3lSZXN1bHQgfSBmcm9tICdAYXdzLWFtcGxpZnkvYmFja2VuZC1kZXBsb3llcic7XG5pbXBvcnQgeyBmb3JtYXQsIHByaW50ZXIgfSBmcm9tICdAYXdzLWFtcGxpZnkvY2xpLWNvcmUnO1xuXG4vKipcbiAqIENvb3JkaW5hdGVzIGNyZWF0aW9uIG9mIHNhbmRib3ggZXZlbnQgaGFuZGxlcnNcbiAqL1xuZXhwb3J0IGNsYXNzIFNhbmRib3hFdmVudEhhbmRsZXJGYWN0b3J5IHtcbiAgLyoqXG4gICAqIENyZWF0ZXMgYSBTYW5kYm94RXZlbnRIYW5kbGVyRmFjdG9yeVxuICAgKi9cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBnZXRCYWNrZW5kSWRlbnRpZmllcjogKFxuICAgICAgc2FuZGJveElkZW50aWZpZXI/OiBzdHJpbmcsXG4gICAgKSA9PiBQcm9taXNlPEJhY2tlbmRJZGVudGlmaWVyPixcbiAgICBwcml2YXRlIHJlYWRvbmx5IGdldFVzYWdlRGF0YUVtaXR0ZXI6ICgpID0+IFByb21pc2U8VXNhZ2VEYXRhRW1pdHRlcj4sXG4gICkge31cblxuICBnZXRTYW5kYm94RXZlbnRIYW5kbGVyczogU2FuZGJveEV2ZW50SGFuZGxlckNyZWF0b3IgPSAoe1xuICAgIHNhbmRib3hJZGVudGlmaWVyOiBzYW5kYm94SWRlbnRpZmllcixcbiAgICBjbGllbnRDb25maWdMaWZlY3ljbGVIYW5kbGVyLFxuICB9KSA9PiB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHN1Y2Nlc3NmdWxEZXBsb3ltZW50OiBbXG4gICAgICAgIGFzeW5jICguLi5hcmdzOiB1bmtub3duW10pID0+IHtcbiAgICAgICAgICBjb25zdCBiYWNrZW5kSWRlbnRpZmllciA9XG4gICAgICAgICAgICBhd2FpdCB0aGlzLmdldEJhY2tlbmRJZGVudGlmaWVyKHNhbmRib3hJZGVudGlmaWVyKTtcbiAgICAgICAgICBjb25zdCB1c2FnZURhdGFFbWl0dGVyID0gYXdhaXQgdGhpcy5nZXRVc2FnZURhdGFFbWl0dGVyKCk7XG4gICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGF3YWl0IGNsaWVudENvbmZpZ0xpZmVjeWNsZUhhbmRsZXIuZ2VuZXJhdGVDbGllbnRDb25maWdGaWxlKFxuICAgICAgICAgICAgICBiYWNrZW5kSWRlbnRpZmllcixcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICBpZiAoYXJncyAmJiBhcmdzWzBdKSB7XG4gICAgICAgICAgICAgIGNvbnN0IGRlcGxveVJlc3VsdCA9IGFyZ3NbMF0gYXMgRGVwbG95UmVzdWx0O1xuICAgICAgICAgICAgICBpZiAoZGVwbG95UmVzdWx0ICYmIGRlcGxveVJlc3VsdC5kZXBsb3ltZW50VGltZXMpIHtcbiAgICAgICAgICAgICAgICBhd2FpdCB1c2FnZURhdGFFbWl0dGVyLmVtaXRTdWNjZXNzKFxuICAgICAgICAgICAgICAgICAgZGVwbG95UmVzdWx0LmRlcGxveW1lbnRUaW1lcyxcbiAgICAgICAgICAgICAgICAgIHsgY29tbWFuZDogJ1NhbmRib3gnIH0sXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAvLyBEb24ndCBjcmFzaCBzYW5kYm94IGlmIGNvbmZpZyBjYW5ub3QgYmUgZ2VuZXJhdGVkLCBidXQgcHJpbnQgdGhlIGVycm9yIG1lc3NhZ2VcbiAgICAgICAgICAgIHByaW50ZXIucHJpbnQoXG4gICAgICAgICAgICAgIGAke2Zvcm1hdC5lcnJvcihcbiAgICAgICAgICAgICAgICAnQW1wbGlmeSBvdXRwdXRzIGNvdWxkIG5vdCBiZSBnZW5lcmF0ZWQuJyxcbiAgICAgICAgICAgICAgKX0gJHtmb3JtYXQuZXJyb3IoZXJyb3IpfWAsXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgIF0sXG4gICAgICBzdWNjZXNzZnVsRGVsZXRpb246IFtcbiAgICAgICAgYXN5bmMgKCkgPT4ge1xuICAgICAgICAgIGF3YWl0IGNsaWVudENvbmZpZ0xpZmVjeWNsZUhhbmRsZXIuZGVsZXRlQ2xpZW50Q29uZmlnRmlsZSgpO1xuICAgICAgICB9LFxuICAgICAgXSxcbiAgICAgIGZhaWxlZERlcGxveW1lbnQ6IFtcbiAgICAgICAgYXN5bmMgKC4uLmFyZ3M6IHVua25vd25bXSkgPT4ge1xuICAgICAgICAgIGNvbnN0IHVzYWdlRGF0YUVtaXR0ZXIgPSBhd2FpdCB0aGlzLmdldFVzYWdlRGF0YUVtaXR0ZXIoKTtcbiAgICAgICAgICBpZiAoYXJncy5sZW5ndGggPT0gMCB8fCAhYXJnc1swXSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgIH1cbiAgICAgICAgICBjb25zdCBkZXBsb3lFcnJvciA9IGFyZ3NbMF07XG4gICAgICAgICAgaWYgKGRlcGxveUVycm9yICYmIEFtcGxpZnlFcnJvci5pc0FtcGxpZnlFcnJvcihkZXBsb3lFcnJvcikpIHtcbiAgICAgICAgICAgIGF3YWl0IHVzYWdlRGF0YUVtaXR0ZXIuZW1pdEZhaWx1cmUoZGVwbG95RXJyb3IsIHtcbiAgICAgICAgICAgICAgY29tbWFuZDogJ1NhbmRib3gnLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGF3YWl0IHVzYWdlRGF0YUVtaXR0ZXIuZW1pdEZhaWx1cmUoXG4gICAgICAgICAgICAgIEFtcGxpZnlFcnJvci5mcm9tRXJyb3IoZGVwbG95RXJyb3IpLFxuICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgY29tbWFuZDogJ1NhbmRib3gnLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICBdLFxuICAgIH07XG4gIH07XG59XG4iXX0=