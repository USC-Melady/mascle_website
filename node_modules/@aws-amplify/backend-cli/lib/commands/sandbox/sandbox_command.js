import fs from 'fs';
import fsp from 'fs/promises';
import { format, printer } from '@aws-amplify/cli-core';
import { ClientConfigFormat, ClientConfigVersionOption, DEFAULT_CLIENT_CONFIG_VERSION, generateEmptyClientConfigToFile, getClientConfigFileName, getClientConfigPath, } from '@aws-amplify/client-config';
import { ClientConfigLifecycleHandler } from '../../client-config/client_config_lifecycle_handler.js';
import { AmplifyUserError } from '@aws-amplify/platform-core';
/**
 * Command that starts sandbox.
 */
export class SandboxCommand {
    sandboxFactory;
    sandboxSubCommands;
    clientConfigGeneratorAdapter;
    commandMiddleware;
    sandboxEventHandlerCreator;
    /**
     * @inheritDoc
     */
    command;
    /**
     * @inheritDoc
     */
    describe;
    sandboxIdentifier;
    profile;
    /**
     * Creates sandbox command.
     */
    constructor(sandboxFactory, sandboxSubCommands, clientConfigGeneratorAdapter, commandMiddleware, sandboxEventHandlerCreator) {
        this.sandboxFactory = sandboxFactory;
        this.sandboxSubCommands = sandboxSubCommands;
        this.clientConfigGeneratorAdapter = clientConfigGeneratorAdapter;
        this.commandMiddleware = commandMiddleware;
        this.sandboxEventHandlerCreator = sandboxEventHandlerCreator;
        this.command = 'sandbox';
        this.describe =
            'Starts sandbox, watch mode for Amplify backend deployments';
    }
    /**
     * @inheritDoc
     */
    handler = async (args) => {
        const sandbox = await this.sandboxFactory.getInstance();
        this.sandboxIdentifier = args.identifier;
        this.profile = args.profile;
        // attaching event handlers
        const clientConfigLifecycleHandler = new ClientConfigLifecycleHandler(this.clientConfigGeneratorAdapter, args.outputsVersion, args.outputsOutDir, args.outputsFormat);
        const eventHandlers = this.sandboxEventHandlerCreator?.({
            sandboxIdentifier: this.sandboxIdentifier,
            clientConfigLifecycleHandler,
        });
        if (eventHandlers) {
            Object.entries(eventHandlers).forEach(([event, handlers]) => {
                handlers.forEach((handler) => sandbox.on(event, handler));
            });
        }
        const watchExclusions = args.exclude ?? [];
        const fileName = getClientConfigFileName(args.outputsVersion);
        const clientConfigWritePath = await getClientConfigPath(fileName, args.outputsOutDir, args.outputsFormat);
        if (!fs.existsSync(clientConfigWritePath)) {
            await generateEmptyClientConfigToFile(args.outputsVersion, args.outputsOutDir, args.outputsFormat);
        }
        watchExclusions.push(clientConfigWritePath);
        let functionStreamingOptions = {
            enabled: false,
        };
        if (args.streamFunctionLogs) {
            // turn on function logs streaming
            functionStreamingOptions = {
                enabled: true,
                logsFilters: args.logsFilter,
                logsOutFile: args.logsOutFile,
            };
            if (args.logsOutFile) {
                watchExclusions.push(args.logsOutFile);
            }
        }
        await sandbox.start({
            dir: args.dirToWatch,
            exclude: watchExclusions,
            identifier: args.identifier,
            profile: args.profile,
            watchForChanges: !args.once,
            functionStreamingOptions,
        });
        process.once('SIGINT', () => void this.sigIntHandler());
    };
    /**
     * @inheritDoc
     */
    builder = (yargs) => {
        return (yargs
            // Cast to erase options types used in internal sub command implementation. Otherwise, compiler fails here.
            .command(this.sandboxSubCommands)
            .version(false)
            .option('dir-to-watch', {
            describe: 'Directory to watch for file changes. All subdirectories and files will be included. Defaults to the amplify directory.',
            type: 'string',
            array: false,
            global: false,
        })
            .option('exclude', {
            describe: 'An array of paths or glob patterns to ignore. Paths can be relative or absolute and can either be files or directories',
            type: 'string',
            array: true,
            global: false,
        })
            .option('identifier', {
            describe: 'An optional identifier to distinguish between different sandboxes. Default is the name of the system user executing the process',
            type: 'string',
            array: false,
        })
            .option('outputs-format', {
            describe: 'amplify_outputs file format',
            type: 'string',
            array: false,
            choices: Object.values(ClientConfigFormat),
            global: false,
        })
            .option('outputs-version', {
            describe: 'Version of the configuration. Version 0 represents classic amplify-cli config file amplify-configuration and 1 represents newer config file amplify_outputs',
            type: 'string',
            array: false,
            choices: Object.values(ClientConfigVersionOption),
            global: false,
            default: DEFAULT_CLIENT_CONFIG_VERSION,
        })
            .option('outputs-out-dir', {
            describe: 'A path to directory where amplify_outputs is written. If not provided defaults to current process working directory.',
            type: 'string',
            array: false,
            global: false,
        })
            .option('profile', {
            describe: 'An AWS profile name.',
            type: 'string',
            array: false,
        })
            .option('once', {
            describe: 'Execute a single sandbox deployment without watching for future file changes',
            boolean: true,
            global: false,
        })
            .option('stream-function-logs', {
            describe: 'Whether to stream function execution logs. Default: false. Use --logs-filter in addition to this flag to stream specific function logs',
            boolean: true,
            global: false,
            group: 'Logs streaming',
        })
            .option('logs-filter', {
            describe: `Regex pattern to filter logs from only matched functions. E.g. to stream logs for a function, specify it's name, and to stream logs from all functions starting with auth specify 'auth' Default: Stream all logs`,
            array: true,
            type: 'string',
            group: 'Logs streaming',
            implies: ['stream-function-logs'],
            requiresArg: true,
        })
            .option('logs-out-file', {
            describe: 'File to append the streaming logs. The file is created if it does not exist. Default: stdout',
            array: false,
            type: 'string',
            group: 'Logs streaming',
            implies: ['stream-function-logs'],
            requiresArg: true,
        })
            .check(async (argv) => {
            if (argv['dir-to-watch']) {
                await this.validateDirectory('dir-to-watch', argv['dir-to-watch']);
            }
            if (argv.identifier) {
                const identifierRegex = /^[a-zA-Z0-9-]{1,15}$/;
                if (!argv.identifier.match(identifierRegex)) {
                    throw new AmplifyUserError('InvalidCommandInputError', {
                        message: `Invalid --identifier provided: ${argv.identifier}`,
                        resolution: 'Use an identifier that matches [a-zA-Z0-9-] and is less than 15 characters.',
                    });
                }
            }
            return true;
        })
            .conflicts('once', [
            'exclude',
            'dir-to-watch',
            'stream-function-logs',
            'logs-filter',
            'logs-out-file',
        ])
            .middleware([this.commandMiddleware.ensureAwsCredentialAndRegion]));
    };
    sigIntHandler = async () => {
        printer.print(`Stopping the sandbox process. To delete the sandbox, run ${format.normalizeAmpxCommand('sandbox delete')}`);
    };
    validateDirectory = async (option, dir) => {
        let stats;
        try {
            stats = await fsp.stat(dir, {});
        }
        catch (e) {
            throw new Error(`--${option} ${dir} does not exist`, { cause: e });
        }
        if (!stats.isDirectory()) {
            throw new Error(`--${option} ${dir} is not a valid directory`);
        }
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2FuZGJveF9jb21tYW5kLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2NvbW1hbmRzL3NhbmRib3gvc2FuZGJveF9jb21tYW5kLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxNQUFNLElBQUksQ0FBQztBQUNwQixPQUFPLEdBQUcsTUFBTSxhQUFhLENBQUM7QUFDOUIsT0FBTyxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUt4RCxPQUFPLEVBQ0wsa0JBQWtCLEVBRWxCLHlCQUF5QixFQUN6Qiw2QkFBNkIsRUFDN0IsK0JBQStCLEVBQy9CLHVCQUF1QixFQUN2QixtQkFBbUIsR0FDcEIsTUFBTSw0QkFBNEIsQ0FBQztBQUNwQyxPQUFPLEVBQUUsNEJBQTRCLEVBQUUsTUFBTSx3REFBd0QsQ0FBQztBQUt0RyxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQWlDOUQ7O0dBRUc7QUFDSCxNQUFNLE9BQU8sY0FBYztJQW9CTjtJQUNBO0lBQ1Q7SUFDQTtJQUNTO0lBckJuQjs7T0FFRztJQUNNLE9BQU8sQ0FBUztJQUV6Qjs7T0FFRztJQUNNLFFBQVEsQ0FBUztJQUVsQixpQkFBaUIsQ0FBVTtJQUMzQixPQUFPLENBQVU7SUFFekI7O09BRUc7SUFDSCxZQUNtQixjQUF1QyxFQUN2QyxrQkFBbUMsRUFDNUMsNEJBQTBELEVBQzFELGlCQUFvQyxFQUMzQiwwQkFBdUQ7UUFKdkQsbUJBQWMsR0FBZCxjQUFjLENBQXlCO1FBQ3ZDLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBaUI7UUFDNUMsaUNBQTRCLEdBQTVCLDRCQUE0QixDQUE4QjtRQUMxRCxzQkFBaUIsR0FBakIsaUJBQWlCLENBQW1CO1FBQzNCLCtCQUEwQixHQUExQiwwQkFBMEIsQ0FBNkI7UUFFeEUsSUFBSSxDQUFDLE9BQU8sR0FBRyxTQUFTLENBQUM7UUFDekIsSUFBSSxDQUFDLFFBQVE7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LDJCQUEyQixDQUFDLENBQUM7U0FDaEU7SUFDSCxDQUFDLENBQUM7Q0FDSCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFyZ3VtZW50c0NhbWVsQ2FzZSwgQXJndiwgQ29tbWFuZE1vZHVsZSB9IGZyb20gJ3lhcmdzJztcbmltcG9ydCBmcyBmcm9tICdmcyc7XG5pbXBvcnQgZnNwIGZyb20gJ2ZzL3Byb21pc2VzJztcbmltcG9ydCB7IGZvcm1hdCwgcHJpbnRlciB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9jbGktY29yZSc7XG5pbXBvcnQge1xuICBTYW5kYm94RnVuY3Rpb25TdHJlYW1pbmdPcHRpb25zLFxuICBTYW5kYm94U2luZ2xldG9uRmFjdG9yeSxcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L3NhbmRib3gnO1xuaW1wb3J0IHtcbiAgQ2xpZW50Q29uZmlnRm9ybWF0LFxuICBDbGllbnRDb25maWdWZXJzaW9uLFxuICBDbGllbnRDb25maWdWZXJzaW9uT3B0aW9uLFxuICBERUZBVUxUX0NMSUVOVF9DT05GSUdfVkVSU0lPTixcbiAgZ2VuZXJhdGVFbXB0eUNsaWVudENvbmZpZ1RvRmlsZSxcbiAgZ2V0Q2xpZW50Q29uZmlnRmlsZU5hbWUsXG4gIGdldENsaWVudENvbmZpZ1BhdGgsXG59IGZyb20gJ0Bhd3MtYW1wbGlmeS9jbGllbnQtY29uZmlnJztcbmltcG9ydCB7IENsaWVudENvbmZpZ0xpZmVjeWNsZUhhbmRsZXIgfSBmcm9tICcuLi8uLi9jbGllbnQtY29uZmlnL2NsaWVudF9jb25maWdfbGlmZWN5Y2xlX2hhbmRsZXIuanMnO1xuaW1wb3J0IHsgQ2xpZW50Q29uZmlnR2VuZXJhdG9yQWRhcHRlciB9IGZyb20gJy4uLy4uL2NsaWVudC1jb25maWcvY2xpZW50X2NvbmZpZ19nZW5lcmF0b3JfYWRhcHRlci5qcyc7XG5pbXBvcnQgeyBDb21tYW5kTWlkZGxld2FyZSB9IGZyb20gJy4uLy4uL2NvbW1hbmRfbWlkZGxld2FyZS5qcyc7XG5pbXBvcnQgeyBTYW5kYm94Q29tbWFuZEdsb2JhbE9wdGlvbnMgfSBmcm9tICcuL29wdGlvbl90eXBlcy5qcyc7XG5pbXBvcnQgeyBBcmd1bWVudHNLZWJhYkNhc2UgfSBmcm9tICcuLi8uLi9rZWJhYl9jYXNlLmpzJztcbmltcG9ydCB7IEFtcGxpZnlVc2VyRXJyb3IgfSBmcm9tICdAYXdzLWFtcGxpZnkvcGxhdGZvcm0tY29yZSc7XG5cbmV4cG9ydCB0eXBlIFNhbmRib3hDb21tYW5kT3B0aW9uc0tlYmFiQ2FzZSA9IEFyZ3VtZW50c0tlYmFiQ2FzZTxcbiAge1xuICAgIGRpclRvV2F0Y2g6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgICBleGNsdWRlOiBzdHJpbmdbXSB8IHVuZGVmaW5lZDtcbiAgICBvdXRwdXRzRm9ybWF0OiBDbGllbnRDb25maWdGb3JtYXQgfCB1bmRlZmluZWQ7XG4gICAgb3V0cHV0c091dERpcjogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICAgIG91dHB1dHNWZXJzaW9uOiBzdHJpbmc7XG4gICAgb25jZTogYm9vbGVhbiB8IHVuZGVmaW5lZDtcbiAgICBzdHJlYW1GdW5jdGlvbkxvZ3M6IGJvb2xlYW4gfCB1bmRlZmluZWQ7XG4gICAgbG9nc0ZpbHRlcjogc3RyaW5nW10gfCB1bmRlZmluZWQ7XG4gICAgbG9nc091dEZpbGU6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgfSAmIFNhbmRib3hDb21tYW5kR2xvYmFsT3B0aW9uc1xuPjtcblxuZXhwb3J0IHR5cGUgRXZlbnRIYW5kbGVyID0gKC4uLmFyZ3M6IHVua25vd25bXSkgPT4gdm9pZDtcblxuZXhwb3J0IHR5cGUgU2FuZGJveEV2ZW50SGFuZGxlcnMgPSB7XG4gIHN1Y2Nlc3NmdWxEZXBsb3ltZW50OiBFdmVudEhhbmRsZXJbXTtcbiAgc3VjY2Vzc2Z1bERlbGV0aW9uOiBFdmVudEhhbmRsZXJbXTtcbiAgZmFpbGVkRGVwbG95bWVudDogRXZlbnRIYW5kbGVyW107XG59O1xuXG5leHBvcnQgdHlwZSBTYW5kYm94RXZlbnRIYW5kbGVyUGFyYW1zID0ge1xuICBzYW5kYm94SWRlbnRpZmllcj86IHN0cmluZztcbiAgY2xpZW50Q29uZmlnTGlmZWN5Y2xlSGFuZGxlcjogQ2xpZW50Q29uZmlnTGlmZWN5Y2xlSGFuZGxlcjtcbn07XG5cbmV4cG9ydCB0eXBlIFNhbmRib3hFdmVudEhhbmRsZXJDcmVhdG9yID0gKFxuICBwYXJhbXM6IFNhbmRib3hFdmVudEhhbmRsZXJQYXJhbXMsXG4pID0+IFNhbmRib3hFdmVudEhhbmRsZXJzO1xuXG4vKipcbiAqIENvbW1hbmQgdGhhdCBzdGFydHMgc2FuZGJveC5cbiAqL1xuZXhwb3J0IGNsYXNzIFNhbmRib3hDb21tYW5kXG4gIGltcGxlbWVudHMgQ29tbWFuZE1vZHVsZTxvYmplY3QsIFNhbmRib3hDb21tYW5kT3B0aW9uc0tlYmFiQ2FzZT5cbntcbiAgLyoqXG4gICAqIEBpbmhlcml0RG9jXG4gICAqL1xuICByZWFkb25seSBjb21tYW5kOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIEBpbmhlcml0RG9jXG4gICAqL1xuICByZWFkb25seSBkZXNjcmliZTogc3RyaW5nO1xuXG4gIHByaXZhdGUgc2FuZGJveElkZW50aWZpZXI/OiBzdHJpbmc7XG4gIHByaXZhdGUgcHJvZmlsZT86IHN0cmluZztcblxuICAvKipcbiAgICogQ3JlYXRlcyBzYW5kYm94IGNvbW1hbmQuXG4gICAqL1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IHNhbmRib3hGYWN0b3J5OiBTYW5kYm94U2luZ2xldG9uRmFjdG9yeSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IHNhbmRib3hTdWJDb21tYW5kczogQ29tbWFuZE1vZHVsZVtdLFxuICAgIHByaXZhdGUgY2xpZW50Q29uZmlnR2VuZXJhdG9yQWRhcHRlcjogQ2xpZW50Q29uZmlnR2VuZXJhdG9yQWRhcHRlcixcbiAgICBwcml2YXRlIGNvbW1hbmRNaWRkbGV3YXJlOiBDb21tYW5kTWlkZGxld2FyZSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IHNhbmRib3hFdmVudEhhbmRsZXJDcmVhdG9yPzogU2FuZGJveEV2ZW50SGFuZGxlckNyZWF0b3IsXG4gICkge1xuICAgIHRoaXMuY29tbWFuZCA9ICdzYW5kYm94JztcbiAgICB0aGlzLmRlc2NyaWJlID1cbiAgICAgICdTdGFydHMgc2FuZGJveCwgd2F0Y2ggbW9kZSBmb3IgQW1wbGlmeSBiYWNrZW5kIGRlcGxveW1lbnRzJztcbiAgfVxuXG4gIC8qKlxuICAgKiBAaW5oZXJpdERvY1xuICAgKi9cbiAgaGFuZGxlciA9IGFzeW5jIChcbiAgICBhcmdzOiBBcmd1bWVudHNDYW1lbENhc2U8U2FuZGJveENvbW1hbmRPcHRpb25zS2ViYWJDYXNlPixcbiAgKTogUHJvbWlzZTx2b2lkPiA9PiB7XG4gICAgY29uc3Qgc2FuZGJveCA9IGF3YWl0IHRoaXMuc2FuZGJveEZhY3RvcnkuZ2V0SW5zdGFuY2UoKTtcbiAgICB0aGlzLnNhbmRib3hJZGVudGlmaWVyID0gYXJncy5pZGVudGlmaWVyO1xuICAgIHRoaXMucHJvZmlsZSA9IGFyZ3MucHJvZmlsZTtcblxuICAgIC8vIGF0dGFjaGluZyBldmVudCBoYW5kbGVyc1xuICAgIGNvbnN0IGNsaWVudENvbmZpZ0xpZmVjeWNsZUhhbmRsZXIgPSBuZXcgQ2xpZW50Q29uZmlnTGlmZWN5Y2xlSGFuZGxlcihcbiAgICAgIHRoaXMuY2xpZW50Q29uZmlnR2VuZXJhdG9yQWRhcHRlcixcbiAgICAgIGFyZ3Mub3V0cHV0c1ZlcnNpb24gYXMgQ2xpZW50Q29uZmlnVmVyc2lvbixcbiAgICAgIGFyZ3Mub3V0cHV0c091dERpcixcbiAgICAgIGFyZ3Mub3V0cHV0c0Zvcm1hdCxcbiAgICApO1xuICAgIGNvbnN0IGV2ZW50SGFuZGxlcnMgPSB0aGlzLnNhbmRib3hFdmVudEhhbmRsZXJDcmVhdG9yPy4oe1xuICAgICAgc2FuZGJveElkZW50aWZpZXI6IHRoaXMuc2FuZGJveElkZW50aWZpZXIsXG4gICAgICBjbGllbnRDb25maWdMaWZlY3ljbGVIYW5kbGVyLFxuICAgIH0pO1xuICAgIGlmIChldmVudEhhbmRsZXJzKSB7XG4gICAgICBPYmplY3QuZW50cmllcyhldmVudEhhbmRsZXJzKS5mb3JFYWNoKChbZXZlbnQsIGhhbmRsZXJzXSkgPT4ge1xuICAgICAgICBoYW5kbGVycy5mb3JFYWNoKChoYW5kbGVyKSA9PiBzYW5kYm94Lm9uKGV2ZW50LCBoYW5kbGVyKSk7XG4gICAgICB9KTtcbiAgICB9XG4gICAgY29uc3Qgd2F0Y2hFeGNsdXNpb25zID0gYXJncy5leGNsdWRlID8/IFtdO1xuICAgIGNvbnN0IGZpbGVOYW1lID0gZ2V0Q2xpZW50Q29uZmlnRmlsZU5hbWUoXG4gICAgICBhcmdzLm91dHB1dHNWZXJzaW9uIGFzIENsaWVudENvbmZpZ1ZlcnNpb24sXG4gICAgKTtcbiAgICBjb25zdCBjbGllbnRDb25maWdXcml0ZVBhdGggPSBhd2FpdCBnZXRDbGllbnRDb25maWdQYXRoKFxuICAgICAgZmlsZU5hbWUsXG4gICAgICBhcmdzLm91dHB1dHNPdXREaXIsXG4gICAgICBhcmdzLm91dHB1dHNGb3JtYXQsXG4gICAgKTtcblxuICAgIGlmICghZnMuZXhpc3RzU3luYyhjbGllbnRDb25maWdXcml0ZVBhdGgpKSB7XG4gICAgICBhd2FpdCBnZW5lcmF0ZUVtcHR5Q2xpZW50Q29uZmlnVG9GaWxlKFxuICAgICAgICBhcmdzLm91dHB1dHNWZXJzaW9uIGFzIENsaWVudENvbmZpZ1ZlcnNpb24sXG4gICAgICAgIGFyZ3Mub3V0cHV0c091dERpcixcbiAgICAgICAgYXJncy5vdXRwdXRzRm9ybWF0LFxuICAgICAgKTtcbiAgICB9XG5cbiAgICB3YXRjaEV4Y2x1c2lvbnMucHVzaChjbGllbnRDb25maWdXcml0ZVBhdGgpO1xuXG4gICAgbGV0IGZ1bmN0aW9uU3RyZWFtaW5nT3B0aW9uczogU2FuZGJveEZ1bmN0aW9uU3RyZWFtaW5nT3B0aW9ucyA9IHtcbiAgICAgIGVuYWJsZWQ6IGZhbHNlLFxuICAgIH07XG4gICAgaWYgKGFyZ3Muc3RyZWFtRnVuY3Rpb25Mb2dzKSB7XG4gICAgICAvLyB0dXJuIG9uIGZ1bmN0aW9uIGxvZ3Mgc3RyZWFtaW5nXG4gICAgICBmdW5jdGlvblN0cmVhbWluZ09wdGlvbnMgPSB7XG4gICAgICAgIGVuYWJsZWQ6IHRydWUsXG4gICAgICAgIGxvZ3NGaWx0ZXJzOiBhcmdzLmxvZ3NGaWx0ZXIsXG4gICAgICAgIGxvZ3NPdXRGaWxlOiBhcmdzLmxvZ3NPdXRGaWxlLFxuICAgICAgfTtcblxuICAgICAgaWYgKGFyZ3MubG9nc091dEZpbGUpIHtcbiAgICAgICAgd2F0Y2hFeGNsdXNpb25zLnB1c2goYXJncy5sb2dzT3V0RmlsZSk7XG4gICAgICB9XG4gICAgfVxuICAgIGF3YWl0IHNhbmRib3guc3RhcnQoe1xuICAgICAgZGlyOiBhcmdzLmRpclRvV2F0Y2gsXG4gICAgICBleGNsdWRlOiB3YXRjaEV4Y2x1c2lvbnMsXG4gICAgICBpZGVudGlmaWVyOiBhcmdzLmlkZW50aWZpZXIsXG4gICAgICBwcm9maWxlOiBhcmdzLnByb2ZpbGUsXG4gICAgICB3YXRjaEZvckNoYW5nZXM6ICFhcmdzLm9uY2UsXG4gICAgICBmdW5jdGlvblN0cmVhbWluZ09wdGlvbnMsXG4gICAgfSk7XG4gICAgcHJvY2Vzcy5vbmNlKCdTSUdJTlQnLCAoKSA9PiB2b2lkIHRoaXMuc2lnSW50SGFuZGxlcigpKTtcbiAgfTtcblxuICAvKipcbiAgICogQGluaGVyaXREb2NcbiAgICovXG4gIGJ1aWxkZXIgPSAoeWFyZ3M6IEFyZ3YpOiBBcmd2PFNhbmRib3hDb21tYW5kT3B0aW9uc0tlYmFiQ2FzZT4gPT4ge1xuICAgIHJldHVybiAoXG4gICAgICB5YXJnc1xuICAgICAgICAvLyBDYXN0IHRvIGVyYXNlIG9wdGlvbnMgdHlwZXMgdXNlZCBpbiBpbnRlcm5hbCBzdWIgY29tbWFuZCBpbXBsZW1lbnRhdGlvbi4gT3RoZXJ3aXNlLCBjb21waWxlciBmYWlscyBoZXJlLlxuICAgICAgICAuY29tbWFuZCh0aGlzLnNhbmRib3hTdWJDb21tYW5kcylcbiAgICAgICAgLnZlcnNpb24oZmFsc2UpXG4gICAgICAgIC5vcHRpb24oJ2Rpci10by13YXRjaCcsIHtcbiAgICAgICAgICBkZXNjcmliZTpcbiAgICAgICAgICAgICdEaXJlY3RvcnkgdG8gd2F0Y2ggZm9yIGZpbGUgY2hhbmdlcy4gQWxsIHN1YmRpcmVjdG9yaWVzIGFuZCBmaWxlcyB3aWxsIGJlIGluY2x1ZGVkLiBEZWZhdWx0cyB0byB0aGUgYW1wbGlmeSBkaXJlY3RvcnkuJyxcbiAgICAgICAgICB0eXBlOiAnc3RyaW5nJyxcbiAgICAgICAgICBhcnJheTogZmFsc2UsXG4gICAgICAgICAgZ2xvYmFsOiBmYWxzZSxcbiAgICAgICAgfSlcbiAgICAgICAgLm9wdGlvbignZXhjbHVkZScsIHtcbiAgICAgICAgICBkZXNjcmliZTpcbiAgICAgICAgICAgICdBbiBhcnJheSBvZiBwYXRocyBvciBnbG9iIHBhdHRlcm5zIHRvIGlnbm9yZS4gUGF0aHMgY2FuIGJlIHJlbGF0aXZlIG9yIGFic29sdXRlIGFuZCBjYW4gZWl0aGVyIGJlIGZpbGVzIG9yIGRpcmVjdG9yaWVzJyxcbiAgICAgICAgICB0eXBlOiAnc3RyaW5nJyxcbiAgICAgICAgICBhcnJheTogdHJ1ZSxcbiAgICAgICAgICBnbG9iYWw6IGZhbHNlLFxuICAgICAgICB9KVxuICAgICAgICAub3B0aW9uKCdpZGVudGlmaWVyJywge1xuICAgICAgICAgIGRlc2NyaWJlOlxuICAgICAgICAgICAgJ0FuIG9wdGlvbmFsIGlkZW50aWZpZXIgdG8gZGlzdGluZ3Vpc2ggYmV0d2VlbiBkaWZmZXJlbnQgc2FuZGJveGVzLiBEZWZhdWx0IGlzIHRoZSBuYW1lIG9mIHRoZSBzeXN0ZW0gdXNlciBleGVjdXRpbmcgdGhlIHByb2Nlc3MnLFxuICAgICAgICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgICAgICAgIGFycmF5OiBmYWxzZSxcbiAgICAgICAgfSlcbiAgICAgICAgLm9wdGlvbignb3V0cHV0cy1mb3JtYXQnLCB7XG4gICAgICAgICAgZGVzY3JpYmU6ICdhbXBsaWZ5X291dHB1dHMgZmlsZSBmb3JtYXQnLFxuICAgICAgICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgICAgICAgIGFycmF5OiBmYWxzZSxcbiAgICAgICAgICBjaG9pY2VzOiBPYmplY3QudmFsdWVzKENsaWVudENvbmZpZ0Zvcm1hdCksXG4gICAgICAgICAgZ2xvYmFsOiBmYWxzZSxcbiAgICAgICAgfSlcbiAgICAgICAgLm9wdGlvbignb3V0cHV0cy12ZXJzaW9uJywge1xuICAgICAgICAgIGRlc2NyaWJlOlxuICAgICAgICAgICAgJ1ZlcnNpb24gb2YgdGhlIGNvbmZpZ3VyYXRpb24uIFZlcnNpb24gMCByZXByZXNlbnRzIGNsYXNzaWMgYW1wbGlmeS1jbGkgY29uZmlnIGZpbGUgYW1wbGlmeS1jb25maWd1cmF0aW9uIGFuZCAxIHJlcHJlc2VudHMgbmV3ZXIgY29uZmlnIGZpbGUgYW1wbGlmeV9vdXRwdXRzJyxcbiAgICAgICAgICB0eXBlOiAnc3RyaW5nJyxcbiAgICAgICAgICBhcnJheTogZmFsc2UsXG4gICAgICAgICAgY2hvaWNlczogT2JqZWN0LnZhbHVlcyhDbGllbnRDb25maWdWZXJzaW9uT3B0aW9uKSxcbiAgICAgICAgICBnbG9iYWw6IGZhbHNlLFxuICAgICAgICAgIGRlZmF1bHQ6IERFRkFVTFRfQ0xJRU5UX0NPTkZJR19WRVJTSU9OLFxuICAgICAgICB9KVxuICAgICAgICAub3B0aW9uKCdvdXRwdXRzLW91dC1kaXInLCB7XG4gICAgICAgICAgZGVzY3JpYmU6XG4gICAgICAgICAgICAnQSBwYXRoIHRvIGRpcmVjdG9yeSB3aGVyZSBhbXBsaWZ5X291dHB1dHMgaXMgd3JpdHRlbi4gSWYgbm90IHByb3ZpZGVkIGRlZmF1bHRzIHRvIGN1cnJlbnQgcHJvY2VzcyB3b3JraW5nIGRpcmVjdG9yeS4nLFxuICAgICAgICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgICAgICAgIGFycmF5OiBmYWxzZSxcbiAgICAgICAgICBnbG9iYWw6IGZhbHNlLFxuICAgICAgICB9KVxuICAgICAgICAub3B0aW9uKCdwcm9maWxlJywge1xuICAgICAgICAgIGRlc2NyaWJlOiAnQW4gQVdTIHByb2ZpbGUgbmFtZS4nLFxuICAgICAgICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgICAgICAgIGFycmF5OiBmYWxzZSxcbiAgICAgICAgfSlcbiAgICAgICAgLm9wdGlvbignb25jZScsIHtcbiAgICAgICAgICBkZXNjcmliZTpcbiAgICAgICAgICAgICdFeGVjdXRlIGEgc2luZ2xlIHNhbmRib3ggZGVwbG95bWVudCB3aXRob3V0IHdhdGNoaW5nIGZvciBmdXR1cmUgZmlsZSBjaGFuZ2VzJyxcbiAgICAgICAgICBib29sZWFuOiB0cnVlLFxuICAgICAgICAgIGdsb2JhbDogZmFsc2UsXG4gICAgICAgIH0pXG4gICAgICAgIC5vcHRpb24oJ3N0cmVhbS1mdW5jdGlvbi1sb2dzJywge1xuICAgICAgICAgIGRlc2NyaWJlOlxuICAgICAgICAgICAgJ1doZXRoZXIgdG8gc3RyZWFtIGZ1bmN0aW9uIGV4ZWN1dGlvbiBsb2dzLiBEZWZhdWx0OiBmYWxzZS4gVXNlIC0tbG9ncy1maWx0ZXIgaW4gYWRkaXRpb24gdG8gdGhpcyBmbGFnIHRvIHN0cmVhbSBzcGVjaWZpYyBmdW5jdGlvbiBsb2dzJyxcbiAgICAgICAgICBib29sZWFuOiB0cnVlLFxuICAgICAgICAgIGdsb2JhbDogZmFsc2UsXG4gICAgICAgICAgZ3JvdXA6ICdMb2dzIHN0cmVhbWluZycsXG4gICAgICAgIH0pXG4gICAgICAgIC5vcHRpb24oJ2xvZ3MtZmlsdGVyJywge1xuICAgICAgICAgIGRlc2NyaWJlOiBgUmVnZXggcGF0dGVybiB0byBmaWx0ZXIgbG9ncyBmcm9tIG9ubHkgbWF0Y2hlZCBmdW5jdGlvbnMuIEUuZy4gdG8gc3RyZWFtIGxvZ3MgZm9yIGEgZnVuY3Rpb24sIHNwZWNpZnkgaXQncyBuYW1lLCBhbmQgdG8gc3RyZWFtIGxvZ3MgZnJvbSBhbGwgZnVuY3Rpb25zIHN0YXJ0aW5nIHdpdGggYXV0aCBzcGVjaWZ5ICdhdXRoJyBEZWZhdWx0OiBTdHJlYW0gYWxsIGxvZ3NgLFxuICAgICAgICAgIGFycmF5OiB0cnVlLFxuICAgICAgICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgICAgICAgIGdyb3VwOiAnTG9ncyBzdHJlYW1pbmcnLFxuICAgICAgICAgIGltcGxpZXM6IFsnc3RyZWFtLWZ1bmN0aW9uLWxvZ3MnXSxcbiAgICAgICAgICByZXF1aXJlc0FyZzogdHJ1ZSxcbiAgICAgICAgfSlcbiAgICAgICAgLm9wdGlvbignbG9ncy1vdXQtZmlsZScsIHtcbiAgICAgICAgICBkZXNjcmliZTpcbiAgICAgICAgICAgICdGaWxlIHRvIGFwcGVuZCB0aGUgc3RyZWFtaW5nIGxvZ3MuIFRoZSBmaWxlIGlzIGNyZWF0ZWQgaWYgaXQgZG9lcyBub3QgZXhpc3QuIERlZmF1bHQ6IHN0ZG91dCcsXG4gICAgICAgICAgYXJyYXk6IGZhbHNlLFxuICAgICAgICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgICAgICAgIGdyb3VwOiAnTG9ncyBzdHJlYW1pbmcnLFxuICAgICAgICAgIGltcGxpZXM6IFsnc3RyZWFtLWZ1bmN0aW9uLWxvZ3MnXSxcbiAgICAgICAgICByZXF1aXJlc0FyZzogdHJ1ZSxcbiAgICAgICAgfSlcbiAgICAgICAgLmNoZWNrKGFzeW5jIChhcmd2KSA9PiB7XG4gICAgICAgICAgaWYgKGFyZ3ZbJ2Rpci10by13YXRjaCddKSB7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLnZhbGlkYXRlRGlyZWN0b3J5KCdkaXItdG8td2F0Y2gnLCBhcmd2WydkaXItdG8td2F0Y2gnXSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChhcmd2LmlkZW50aWZpZXIpIHtcbiAgICAgICAgICAgIGNvbnN0IGlkZW50aWZpZXJSZWdleCA9IC9eW2EtekEtWjAtOS1dezEsMTV9JC87XG4gICAgICAgICAgICBpZiAoIWFyZ3YuaWRlbnRpZmllci5tYXRjaChpZGVudGlmaWVyUmVnZXgpKSB7XG4gICAgICAgICAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yKCdJbnZhbGlkQ29tbWFuZElucHV0RXJyb3InLCB7XG4gICAgICAgICAgICAgICAgbWVzc2FnZTogYEludmFsaWQgLS1pZGVudGlmaWVyIHByb3ZpZGVkOiAke2FyZ3YuaWRlbnRpZmllcn1gLFxuICAgICAgICAgICAgICAgIHJlc29sdXRpb246XG4gICAgICAgICAgICAgICAgICAnVXNlIGFuIGlkZW50aWZpZXIgdGhhdCBtYXRjaGVzIFthLXpBLVowLTktXSBhbmQgaXMgbGVzcyB0aGFuIDE1IGNoYXJhY3RlcnMuJyxcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9KVxuICAgICAgICAuY29uZmxpY3RzKCdvbmNlJywgW1xuICAgICAgICAgICdleGNsdWRlJyxcbiAgICAgICAgICAnZGlyLXRvLXdhdGNoJyxcbiAgICAgICAgICAnc3RyZWFtLWZ1bmN0aW9uLWxvZ3MnLFxuICAgICAgICAgICdsb2dzLWZpbHRlcicsXG4gICAgICAgICAgJ2xvZ3Mtb3V0LWZpbGUnLFxuICAgICAgICBdKVxuICAgICAgICAubWlkZGxld2FyZShbdGhpcy5jb21tYW5kTWlkZGxld2FyZS5lbnN1cmVBd3NDcmVkZW50aWFsQW5kUmVnaW9uXSlcbiAgICApO1xuICB9O1xuXG4gIHNpZ0ludEhhbmRsZXIgPSBhc3luYyAoKSA9PiB7XG4gICAgcHJpbnRlci5wcmludChcbiAgICAgIGBTdG9wcGluZyB0aGUgc2FuZGJveCBwcm9jZXNzLiBUbyBkZWxldGUgdGhlIHNhbmRib3gsIHJ1biAke2Zvcm1hdC5ub3JtYWxpemVBbXB4Q29tbWFuZChcbiAgICAgICAgJ3NhbmRib3ggZGVsZXRlJyxcbiAgICAgICl9YCxcbiAgICApO1xuICB9O1xuXG4gIHByaXZhdGUgdmFsaWRhdGVEaXJlY3RvcnkgPSBhc3luYyAob3B0aW9uOiBzdHJpbmcsIGRpcjogc3RyaW5nKSA9PiB7XG4gICAgbGV0IHN0YXRzO1xuICAgIHRyeSB7XG4gICAgICBzdGF0cyA9IGF3YWl0IGZzcC5zdGF0KGRpciwge30pO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgLS0ke29wdGlvbn0gJHtkaXJ9IGRvZXMgbm90IGV4aXN0YCwgeyBjYXVzZTogZSB9KTtcbiAgICB9XG4gICAgaWYgKCFzdGF0cy5pc0RpcmVjdG9yeSgpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYC0tJHtvcHRpb259ICR7ZGlyfSBpcyBub3QgYSB2YWxpZCBkaXJlY3RvcnlgKTtcbiAgICB9XG4gIH07XG59XG4iXX0=