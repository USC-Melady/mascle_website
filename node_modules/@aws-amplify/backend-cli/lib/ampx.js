#!/usr/bin/env node
import { createMainParser } from './main_parser_factory.js';
import { attachUnhandledExceptionListeners, generateCommandFailureHandler, } from './error_handler.js';
import { extractSubCommands } from './extract_sub_commands.js';
import { AmplifyFault, PackageJsonReader, UsageDataEmitterFactory, } from '@aws-amplify/platform-core';
import { fileURLToPath } from 'node:url';
import { verifyCommandName } from './verify_command_name.js';
import { hideBin } from 'yargs/helpers';
import { PackageManagerControllerFactory, format } from '@aws-amplify/cli-core';
const packageJson = new PackageJsonReader().read(fileURLToPath(new URL('../package.json', import.meta.url)));
const libraryVersion = packageJson.version;
if (libraryVersion == undefined) {
    throw new AmplifyFault('UnknownVersionFault', {
        message: 'Library version cannot be determined. Check the library installation',
    });
}
const dependencies = await new PackageManagerControllerFactory()
    .getPackageManagerController()
    .tryGetDependencies();
const usageDataEmitter = await new UsageDataEmitterFactory().getInstance(libraryVersion, dependencies);
attachUnhandledExceptionListeners(usageDataEmitter);
verifyCommandName();
const parser = createMainParser(libraryVersion);
const errorHandler = generateCommandFailureHandler(parser, usageDataEmitter);
try {
    await parser.parseAsync(hideBin(process.argv));
    const metricDimension = {};
    const subCommands = extractSubCommands(parser);
    if (subCommands) {
        metricDimension.command = subCommands;
    }
    await usageDataEmitter.emitSuccess({}, metricDimension);
}
catch (e) {
    if (e instanceof Error) {
        await errorHandler(format.error(e), e);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYW1weC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9hbXB4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFDQSxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUM1RCxPQUFPLEVBQ0wsaUNBQWlDLEVBQ2pDLDZCQUE2QixHQUM5QixNQUFNLG9CQUFvQixDQUFDO0FBQzVCLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQy9ELE9BQU8sRUFDTCxZQUFZLEVBQ1osaUJBQWlCLEVBQ2pCLHVCQUF1QixHQUN4QixNQUFNLDRCQUE0QixDQUFDO0FBQ3BDLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDekMsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDN0QsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN4QyxPQUFPLEVBQUUsK0JBQStCLEVBQUUsTUFBTSxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFFaEYsTUFBTSxXQUFXLEdBQUcsSUFBSSxpQkFBaUIsRUFBRSxDQUFDLElBQUksQ0FDOUMsYUFBYSxDQUFDLElBQUksR0FBRyxDQUFDLGlCQUFpQixFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FDM0QsQ0FBQztBQUNGLE1BQU0sY0FBYyxHQUFHLFdBQVcsQ0FBQyxPQUFPLENBQUM7QUFFM0MsSUFBSSxjQUFjLElBQUksU0FBUyxFQUFFO0lBQy9CLE1BQU0sSUFBSSxZQUFZLENBQUMscUJBQXFCLEVBQUU7UUFDNUMsT0FBTyxFQUNMLHNFQUFzRTtLQUN6RSxDQUFDLENBQUM7Q0FDSjtBQUVELE1BQU0sWUFBWSxHQUFHLE1BQU0sSUFBSSwrQkFBK0IsRUFBRTtLQUM3RCwyQkFBMkIsRUFBRTtLQUM3QixrQkFBa0IsRUFBRSxDQUFDO0FBRXhCLE1BQU0sZ0JBQWdCLEdBQUcsTUFBTSxJQUFJLHVCQUF1QixFQUFFLENBQUMsV0FBVyxDQUN0RSxjQUFjLEVBQ2QsWUFBWSxDQUNiLENBQUM7QUFFRixpQ0FBaUMsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO0FBRXBELGlCQUFpQixFQUFFLENBQUM7QUFFcEIsTUFBTSxNQUFNLEdBQUcsZ0JBQWdCLENBQUMsY0FBYyxDQUFDLENBQUM7QUFDaEQsTUFBTSxZQUFZLEdBQUcsNkJBQTZCLENBQUMsTUFBTSxFQUFFLGdCQUFnQixDQUFDLENBQUM7QUFFN0UsSUFBSTtJQUNGLE1BQU0sTUFBTSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7SUFDL0MsTUFBTSxlQUFlLEdBQTJCLEVBQUUsQ0FBQztJQUNuRCxNQUFNLFdBQVcsR0FBRyxrQkFBa0IsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUUvQyxJQUFJLFdBQVcsRUFBRTtRQUNmLGVBQWUsQ0FBQyxPQUFPLEdBQUcsV0FBVyxDQUFDO0tBQ3ZDO0lBRUQsTUFBTSxnQkFBZ0IsQ0FBQyxXQUFXLENBQUMsRUFBRSxFQUFFLGVBQWUsQ0FBQyxDQUFDO0NBQ3pEO0FBQUMsT0FBTyxDQUFDLEVBQUU7SUFDVixJQUFJLENBQUMsWUFBWSxLQUFLLEVBQUU7UUFDdEIsTUFBTSxZQUFZLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztLQUN4QztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiIyEvdXNyL2Jpbi9lbnYgbm9kZVxuaW1wb3J0IHsgY3JlYXRlTWFpblBhcnNlciB9IGZyb20gJy4vbWFpbl9wYXJzZXJfZmFjdG9yeS5qcyc7XG5pbXBvcnQge1xuICBhdHRhY2hVbmhhbmRsZWRFeGNlcHRpb25MaXN0ZW5lcnMsXG4gIGdlbmVyYXRlQ29tbWFuZEZhaWx1cmVIYW5kbGVyLFxufSBmcm9tICcuL2Vycm9yX2hhbmRsZXIuanMnO1xuaW1wb3J0IHsgZXh0cmFjdFN1YkNvbW1hbmRzIH0gZnJvbSAnLi9leHRyYWN0X3N1Yl9jb21tYW5kcy5qcyc7XG5pbXBvcnQge1xuICBBbXBsaWZ5RmF1bHQsXG4gIFBhY2thZ2VKc29uUmVhZGVyLFxuICBVc2FnZURhdGFFbWl0dGVyRmFjdG9yeSxcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L3BsYXRmb3JtLWNvcmUnO1xuaW1wb3J0IHsgZmlsZVVSTFRvUGF0aCB9IGZyb20gJ25vZGU6dXJsJztcbmltcG9ydCB7IHZlcmlmeUNvbW1hbmROYW1lIH0gZnJvbSAnLi92ZXJpZnlfY29tbWFuZF9uYW1lLmpzJztcbmltcG9ydCB7IGhpZGVCaW4gfSBmcm9tICd5YXJncy9oZWxwZXJzJztcbmltcG9ydCB7IFBhY2thZ2VNYW5hZ2VyQ29udHJvbGxlckZhY3RvcnksIGZvcm1hdCB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9jbGktY29yZSc7XG5cbmNvbnN0IHBhY2thZ2VKc29uID0gbmV3IFBhY2thZ2VKc29uUmVhZGVyKCkucmVhZChcbiAgZmlsZVVSTFRvUGF0aChuZXcgVVJMKCcuLi9wYWNrYWdlLmpzb24nLCBpbXBvcnQubWV0YS51cmwpKSxcbik7XG5jb25zdCBsaWJyYXJ5VmVyc2lvbiA9IHBhY2thZ2VKc29uLnZlcnNpb247XG5cbmlmIChsaWJyYXJ5VmVyc2lvbiA9PSB1bmRlZmluZWQpIHtcbiAgdGhyb3cgbmV3IEFtcGxpZnlGYXVsdCgnVW5rbm93blZlcnNpb25GYXVsdCcsIHtcbiAgICBtZXNzYWdlOlxuICAgICAgJ0xpYnJhcnkgdmVyc2lvbiBjYW5ub3QgYmUgZGV0ZXJtaW5lZC4gQ2hlY2sgdGhlIGxpYnJhcnkgaW5zdGFsbGF0aW9uJyxcbiAgfSk7XG59XG5cbmNvbnN0IGRlcGVuZGVuY2llcyA9IGF3YWl0IG5ldyBQYWNrYWdlTWFuYWdlckNvbnRyb2xsZXJGYWN0b3J5KClcbiAgLmdldFBhY2thZ2VNYW5hZ2VyQ29udHJvbGxlcigpXG4gIC50cnlHZXREZXBlbmRlbmNpZXMoKTtcblxuY29uc3QgdXNhZ2VEYXRhRW1pdHRlciA9IGF3YWl0IG5ldyBVc2FnZURhdGFFbWl0dGVyRmFjdG9yeSgpLmdldEluc3RhbmNlKFxuICBsaWJyYXJ5VmVyc2lvbixcbiAgZGVwZW5kZW5jaWVzLFxuKTtcblxuYXR0YWNoVW5oYW5kbGVkRXhjZXB0aW9uTGlzdGVuZXJzKHVzYWdlRGF0YUVtaXR0ZXIpO1xuXG52ZXJpZnlDb21tYW5kTmFtZSgpO1xuXG5jb25zdCBwYXJzZXIgPSBjcmVhdGVNYWluUGFyc2VyKGxpYnJhcnlWZXJzaW9uKTtcbmNvbnN0IGVycm9ySGFuZGxlciA9IGdlbmVyYXRlQ29tbWFuZEZhaWx1cmVIYW5kbGVyKHBhcnNlciwgdXNhZ2VEYXRhRW1pdHRlcik7XG5cbnRyeSB7XG4gIGF3YWl0IHBhcnNlci5wYXJzZUFzeW5jKGhpZGVCaW4ocHJvY2Vzcy5hcmd2KSk7XG4gIGNvbnN0IG1ldHJpY0RpbWVuc2lvbjogUmVjb3JkPHN0cmluZywgc3RyaW5nPiA9IHt9O1xuICBjb25zdCBzdWJDb21tYW5kcyA9IGV4dHJhY3RTdWJDb21tYW5kcyhwYXJzZXIpO1xuXG4gIGlmIChzdWJDb21tYW5kcykge1xuICAgIG1ldHJpY0RpbWVuc2lvbi5jb21tYW5kID0gc3ViQ29tbWFuZHM7XG4gIH1cblxuICBhd2FpdCB1c2FnZURhdGFFbWl0dGVyLmVtaXRTdWNjZXNzKHt9LCBtZXRyaWNEaW1lbnNpb24pO1xufSBjYXRjaCAoZSkge1xuICBpZiAoZSBpbnN0YW5jZW9mIEVycm9yKSB7XG4gICAgYXdhaXQgZXJyb3JIYW5kbGVyKGZvcm1hdC5lcnJvcihlKSwgZSk7XG4gIH1cbn1cbiJdfQ==