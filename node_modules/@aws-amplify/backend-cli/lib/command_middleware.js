import { fromNodeProviderChain } from '@aws-sdk/credential-providers';
import { loadConfig } from '@smithy/node-config-provider';
import { NODE_REGION_CONFIG_OPTIONS } from '@aws-sdk/region-config-resolver';
import { AmplifyUserError } from '@aws-amplify/platform-core';
import { format } from '@aws-amplify/cli-core';
/**
 * Contains middleware functions.
 */
export class CommandMiddleware {
    printer;
    /**
     * Creates command middleware.
     */
    constructor(printer) {
        this.printer = printer;
    }
    /**
     * Ensure AWS credentials and region of the input profile (or 'default' if undefined) are available in the provider chain.
     * If the input profile is defined, the environment variable AWS_PROFILE will be set accordingly.
     */
    ensureAwsCredentialAndRegion = async (argv) => {
        /**
         * The AWS CDK respects older CLI v1 variable names that are no longer supported in the
         * latest AWS SDK. Developers that use the older variables and switch between Amplify
         * and CDK tools will experience region mismatch failures when using Amplify tools. Variable
         * names known to cause such failures are mapped here for a better developer experience.
         */
        this.mapEnvironmentVariables('AWS_DEFAULT_REGION', 'AWS_REGION');
        this.mapEnvironmentVariables('AWS_DEFAULT_PROFILE', 'AWS_PROFILE');
        if (argv.profile) {
            process.env.AWS_PROFILE = argv.profile;
        }
        const profileSetupInstruction = `To configure a new Amplify profile, use ${format.normalizeAmpxCommand('configure profile')}.`;
        // Check credentials.
        try {
            await fromNodeProviderChain({
                ignoreCache: true,
            })();
        }
        catch (err) {
            const errorMessage = argv.profile
                ? `Failed to load AWS credentials for profile '${argv.profile}'`
                : 'Failed to load default AWS credentials';
            throw new AmplifyUserError('InvalidCredentialError', {
                message: errorMessage,
                resolution: profileSetupInstruction,
            }, err);
        }
        // Check region.
        let region = undefined;
        try {
            region = await loadConfig(NODE_REGION_CONFIG_OPTIONS, {
                ignoreCache: true,
            })();
        }
        catch (err) {
            const errorMessage = argv.profile
                ? `Failed to load AWS region for profile '${argv.profile}'`
                : 'Failed to load default AWS region';
            throw new AmplifyUserError('InvalidCredentialError', {
                message: errorMessage,
                resolution: profileSetupInstruction,
            }, err);
        }
        if (!region.trim()) {
            throw new AmplifyUserError('InvalidCredentialError', {
                message: 'The AWS region is blank',
                resolution: 'Ensure that a valid AWS region is provided in profile configuration or AWS_REGION environment variable.',
            });
        }
    };
    /**
     * Maps one environment variable name to the other
     */
    mapEnvironmentVariables(legacyName, preferredName) {
        if (!process.env[legacyName]) {
            return;
        }
        if (process.env[preferredName]) {
            this.printer.log(`Both the legacy '${legacyName}' and preferred '${preferredName}' environment variables detected. Using '${preferredName}'`);
            return;
        }
        this.printer.log(`Legacy environment variable '${legacyName}' detected. Mapping to '${preferredName}'`);
        process.env[preferredName] = process.env[legacyName];
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tbWFuZF9taWRkbGV3YXJlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2NvbW1hbmRfbWlkZGxld2FyZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUN0RSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFDMUQsT0FBTyxFQUFFLDBCQUEwQixFQUFFLE1BQU0saUNBQWlDLENBQUM7QUFDN0UsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDOUQsT0FBTyxFQUFXLE1BQU0sRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBRXhEOztHQUVHO0FBQ0gsTUFBTSxPQUFPLGlCQUFpQjtJQUlDO0lBSDdCOztPQUVHO0lBQ0gsWUFBNkIsT0FBZ0I7UUFBaEIsWUFBTyxHQUFQLE9BQU8sQ0FBUztJQUFHLENBQUM7SUFFakQ7OztPQUdHO0lBQ0gsNEJBQTRCLEdBQUcsS0FBSyxFQUdsQyxJQUEyQixFQUMzQixFQUFFO1FBQ0Y7Ozs7O1dBS0c7UUFDSCxJQUFJLENBQUMsdUJBQXVCLENBQUMsb0JBQW9CLEVBQUUsWUFBWSxDQUFDLENBQUM7UUFDakUsSUFBSSxDQUFDLHVCQUF1QixDQUFDLHFCQUFxQixFQUFFLGFBQWEsQ0FBQyxDQUFDO1FBRW5FLElBQUksSUFBSSxDQUFDLE9BQU8sRUFBRTtZQUNoQixPQUFPLENBQUMsR0FBRyxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDO1NBQ3hDO1FBRUQsTUFBTSx1QkFBdUIsR0FBRywyQ0FBMkMsTUFBTSxDQUFDLG9CQUFvQixDQUNwRyxtQkFBbUIsQ0FDcEIsR0FBRyxDQUFDO1FBRUwscUJBQXFCO1FBQ3JCLElBQUk7WUFDRixNQUFNLHFCQUFxQixDQUFDO2dCQUMxQixXQUFXLEVBQUUsSUFBSTthQUNsQixDQUFDLEVBQUUsQ0FBQztTQUNOO1FBQUMsT0FBTyxHQUFHLEVBQUU7WUFDWixNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsT0FBTztnQkFDL0IsQ0FBQyxDQUFDLCtDQUErQyxJQUFJLENBQUMsT0FBTyxHQUFHO2dCQUNoRSxDQUFDLENBQUMsd0NBQXdDLENBQUM7WUFDN0MsTUFBTSxJQUFJLGdCQUFnQixDQUN4Qix3QkFBd0IsRUFDeEI7Z0JBQ0UsT0FBTyxFQUFFLFlBQVk7Z0JBQ3JCLFVBQVUsRUFBRSx1QkFBdUI7YUFDcEMsRUFDRCxHQUFZLENBQ2IsQ0FBQztTQUNIO1FBRUQsZ0JBQWdCO1FBQ2hCLElBQUksTUFBTSxHQUF1QixTQUFTLENBQUM7UUFDM0MsSUFBSTtZQUNGLE1BQU0sR0FBRyxNQUFNLFVBQVUsQ0FBQywwQkFBMEIsRUFBRTtnQkFDcEQsV0FBVyxFQUFFLElBQUk7YUFDbEIsQ0FBQyxFQUFFLENBQUM7U0FDTjtRQUFDLE9BQU8sR0FBRyxFQUFFO1lBQ1osTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLE9BQU87Z0JBQy9CLENBQUMsQ0FBQywwQ0FBMEMsSUFBSSxDQUFDLE9BQU8sR0FBRztnQkFDM0QsQ0FBQyxDQUFDLG1DQUFtQyxDQUFDO1lBQ3hDLE1BQU0sSUFBSSxnQkFBZ0IsQ0FDeEIsd0JBQXdCLEVBQ3hCO2dCQUNFLE9BQU8sRUFBRSxZQUFZO2dCQUNyQixVQUFVLEVBQUUsdUJBQXVCO2FBQ3BDLEVBQ0QsR0FBWSxDQUNiLENBQUM7U0FDSDtRQUNELElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLEVBQUU7WUFDbEIsTUFBTSxJQUFJLGdCQUFnQixDQUFDLHdCQUF3QixFQUFFO2dCQUNuRCxPQUFPLEVBQUUseUJBQXlCO2dCQUNsQyxVQUFVLEVBQ1IseUdBQXlHO2FBQzVHLENBQUMsQ0FBQztTQUNKO0lBQ0gsQ0FBQyxDQUFDO0lBRUY7O09BRUc7SUFDSyx1QkFBdUIsQ0FDN0IsVUFBa0IsRUFDbEIsYUFBcUI7UUFFckIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLEVBQUU7WUFDNUIsT0FBTztTQUNSO1FBQ0QsSUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxFQUFFO1lBQzlCLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUNkLG9CQUFvQixVQUFVLG9CQUFvQixhQUFhLDRDQUE0QyxhQUFhLEdBQUcsQ0FDNUgsQ0FBQztZQUNGLE9BQU87U0FDUjtRQUNELElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUNkLGdDQUFnQyxVQUFVLDJCQUEyQixhQUFhLEdBQUcsQ0FDdEYsQ0FBQztRQUNGLE9BQU8sQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUN2RCxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBcmd1bWVudHNDYW1lbENhc2UgfSBmcm9tICd5YXJncyc7XG5pbXBvcnQgeyBmcm9tTm9kZVByb3ZpZGVyQ2hhaW4gfSBmcm9tICdAYXdzLXNkay9jcmVkZW50aWFsLXByb3ZpZGVycyc7XG5pbXBvcnQgeyBsb2FkQ29uZmlnIH0gZnJvbSAnQHNtaXRoeS9ub2RlLWNvbmZpZy1wcm92aWRlcic7XG5pbXBvcnQgeyBOT0RFX1JFR0lPTl9DT05GSUdfT1BUSU9OUyB9IGZyb20gJ0Bhd3Mtc2RrL3JlZ2lvbi1jb25maWctcmVzb2x2ZXInO1xuaW1wb3J0IHsgQW1wbGlmeVVzZXJFcnJvciB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbGF0Zm9ybS1jb3JlJztcbmltcG9ydCB7IFByaW50ZXIsIGZvcm1hdCB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9jbGktY29yZSc7XG5cbi8qKlxuICogQ29udGFpbnMgbWlkZGxld2FyZSBmdW5jdGlvbnMuXG4gKi9cbmV4cG9ydCBjbGFzcyBDb21tYW5kTWlkZGxld2FyZSB7XG4gIC8qKlxuICAgKiBDcmVhdGVzIGNvbW1hbmQgbWlkZGxld2FyZS5cbiAgICovXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVhZG9ubHkgcHJpbnRlcjogUHJpbnRlcikge31cblxuICAvKipcbiAgICogRW5zdXJlIEFXUyBjcmVkZW50aWFscyBhbmQgcmVnaW9uIG9mIHRoZSBpbnB1dCBwcm9maWxlIChvciAnZGVmYXVsdCcgaWYgdW5kZWZpbmVkKSBhcmUgYXZhaWxhYmxlIGluIHRoZSBwcm92aWRlciBjaGFpbi5cbiAgICogSWYgdGhlIGlucHV0IHByb2ZpbGUgaXMgZGVmaW5lZCwgdGhlIGVudmlyb25tZW50IHZhcmlhYmxlIEFXU19QUk9GSUxFIHdpbGwgYmUgc2V0IGFjY29yZGluZ2x5LlxuICAgKi9cbiAgZW5zdXJlQXdzQ3JlZGVudGlhbEFuZFJlZ2lvbiA9IGFzeW5jIDxcbiAgICBUIGV4dGVuZHMgeyBwcm9maWxlOiBzdHJpbmcgfCB1bmRlZmluZWQgfSxcbiAgPihcbiAgICBhcmd2OiBBcmd1bWVudHNDYW1lbENhc2U8VD4sXG4gICkgPT4ge1xuICAgIC8qKlxuICAgICAqIFRoZSBBV1MgQ0RLIHJlc3BlY3RzIG9sZGVyIENMSSB2MSB2YXJpYWJsZSBuYW1lcyB0aGF0IGFyZSBubyBsb25nZXIgc3VwcG9ydGVkIGluIHRoZVxuICAgICAqIGxhdGVzdCBBV1MgU0RLLiBEZXZlbG9wZXJzIHRoYXQgdXNlIHRoZSBvbGRlciB2YXJpYWJsZXMgYW5kIHN3aXRjaCBiZXR3ZWVuIEFtcGxpZnlcbiAgICAgKiBhbmQgQ0RLIHRvb2xzIHdpbGwgZXhwZXJpZW5jZSByZWdpb24gbWlzbWF0Y2ggZmFpbHVyZXMgd2hlbiB1c2luZyBBbXBsaWZ5IHRvb2xzLiBWYXJpYWJsZVxuICAgICAqIG5hbWVzIGtub3duIHRvIGNhdXNlIHN1Y2ggZmFpbHVyZXMgYXJlIG1hcHBlZCBoZXJlIGZvciBhIGJldHRlciBkZXZlbG9wZXIgZXhwZXJpZW5jZS5cbiAgICAgKi9cbiAgICB0aGlzLm1hcEVudmlyb25tZW50VmFyaWFibGVzKCdBV1NfREVGQVVMVF9SRUdJT04nLCAnQVdTX1JFR0lPTicpO1xuICAgIHRoaXMubWFwRW52aXJvbm1lbnRWYXJpYWJsZXMoJ0FXU19ERUZBVUxUX1BST0ZJTEUnLCAnQVdTX1BST0ZJTEUnKTtcblxuICAgIGlmIChhcmd2LnByb2ZpbGUpIHtcbiAgICAgIHByb2Nlc3MuZW52LkFXU19QUk9GSUxFID0gYXJndi5wcm9maWxlO1xuICAgIH1cblxuICAgIGNvbnN0IHByb2ZpbGVTZXR1cEluc3RydWN0aW9uID0gYFRvIGNvbmZpZ3VyZSBhIG5ldyBBbXBsaWZ5IHByb2ZpbGUsIHVzZSAke2Zvcm1hdC5ub3JtYWxpemVBbXB4Q29tbWFuZChcbiAgICAgICdjb25maWd1cmUgcHJvZmlsZScsXG4gICAgKX0uYDtcblxuICAgIC8vIENoZWNrIGNyZWRlbnRpYWxzLlxuICAgIHRyeSB7XG4gICAgICBhd2FpdCBmcm9tTm9kZVByb3ZpZGVyQ2hhaW4oe1xuICAgICAgICBpZ25vcmVDYWNoZTogdHJ1ZSxcbiAgICAgIH0pKCk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBjb25zdCBlcnJvck1lc3NhZ2UgPSBhcmd2LnByb2ZpbGVcbiAgICAgICAgPyBgRmFpbGVkIHRvIGxvYWQgQVdTIGNyZWRlbnRpYWxzIGZvciBwcm9maWxlICcke2FyZ3YucHJvZmlsZX0nYFxuICAgICAgICA6ICdGYWlsZWQgdG8gbG9hZCBkZWZhdWx0IEFXUyBjcmVkZW50aWFscyc7XG4gICAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcihcbiAgICAgICAgJ0ludmFsaWRDcmVkZW50aWFsRXJyb3InLFxuICAgICAgICB7XG4gICAgICAgICAgbWVzc2FnZTogZXJyb3JNZXNzYWdlLFxuICAgICAgICAgIHJlc29sdXRpb246IHByb2ZpbGVTZXR1cEluc3RydWN0aW9uLFxuICAgICAgICB9LFxuICAgICAgICBlcnIgYXMgRXJyb3IsXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIENoZWNrIHJlZ2lvbi5cbiAgICBsZXQgcmVnaW9uOiBzdHJpbmcgfCB1bmRlZmluZWQgPSB1bmRlZmluZWQ7XG4gICAgdHJ5IHtcbiAgICAgIHJlZ2lvbiA9IGF3YWl0IGxvYWRDb25maWcoTk9ERV9SRUdJT05fQ09ORklHX09QVElPTlMsIHtcbiAgICAgICAgaWdub3JlQ2FjaGU6IHRydWUsXG4gICAgICB9KSgpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgY29uc3QgZXJyb3JNZXNzYWdlID0gYXJndi5wcm9maWxlXG4gICAgICAgID8gYEZhaWxlZCB0byBsb2FkIEFXUyByZWdpb24gZm9yIHByb2ZpbGUgJyR7YXJndi5wcm9maWxlfSdgXG4gICAgICAgIDogJ0ZhaWxlZCB0byBsb2FkIGRlZmF1bHQgQVdTIHJlZ2lvbic7XG4gICAgICB0aHJvdyBuZXcgQW1wbGlmeVVzZXJFcnJvcihcbiAgICAgICAgJ0ludmFsaWRDcmVkZW50aWFsRXJyb3InLFxuICAgICAgICB7XG4gICAgICAgICAgbWVzc2FnZTogZXJyb3JNZXNzYWdlLFxuICAgICAgICAgIHJlc29sdXRpb246IHByb2ZpbGVTZXR1cEluc3RydWN0aW9uLFxuICAgICAgICB9LFxuICAgICAgICBlcnIgYXMgRXJyb3IsXG4gICAgICApO1xuICAgIH1cbiAgICBpZiAoIXJlZ2lvbi50cmltKCkpIHtcbiAgICAgIHRocm93IG5ldyBBbXBsaWZ5VXNlckVycm9yKCdJbnZhbGlkQ3JlZGVudGlhbEVycm9yJywge1xuICAgICAgICBtZXNzYWdlOiAnVGhlIEFXUyByZWdpb24gaXMgYmxhbmsnLFxuICAgICAgICByZXNvbHV0aW9uOlxuICAgICAgICAgICdFbnN1cmUgdGhhdCBhIHZhbGlkIEFXUyByZWdpb24gaXMgcHJvdmlkZWQgaW4gcHJvZmlsZSBjb25maWd1cmF0aW9uIG9yIEFXU19SRUdJT04gZW52aXJvbm1lbnQgdmFyaWFibGUuJyxcbiAgICAgIH0pO1xuICAgIH1cbiAgfTtcblxuICAvKipcbiAgICogTWFwcyBvbmUgZW52aXJvbm1lbnQgdmFyaWFibGUgbmFtZSB0byB0aGUgb3RoZXJcbiAgICovXG4gIHByaXZhdGUgbWFwRW52aXJvbm1lbnRWYXJpYWJsZXMoXG4gICAgbGVnYWN5TmFtZTogc3RyaW5nLFxuICAgIHByZWZlcnJlZE5hbWU6IHN0cmluZyxcbiAgKTogdm9pZCB7XG4gICAgaWYgKCFwcm9jZXNzLmVudltsZWdhY3lOYW1lXSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAocHJvY2Vzcy5lbnZbcHJlZmVycmVkTmFtZV0pIHtcbiAgICAgIHRoaXMucHJpbnRlci5sb2coXG4gICAgICAgIGBCb3RoIHRoZSBsZWdhY3kgJyR7bGVnYWN5TmFtZX0nIGFuZCBwcmVmZXJyZWQgJyR7cHJlZmVycmVkTmFtZX0nIGVudmlyb25tZW50IHZhcmlhYmxlcyBkZXRlY3RlZC4gVXNpbmcgJyR7cHJlZmVycmVkTmFtZX0nYCxcbiAgICAgICk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMucHJpbnRlci5sb2coXG4gICAgICBgTGVnYWN5IGVudmlyb25tZW50IHZhcmlhYmxlICcke2xlZ2FjeU5hbWV9JyBkZXRlY3RlZC4gTWFwcGluZyB0byAnJHtwcmVmZXJyZWROYW1lfSdgLFxuICAgICk7XG4gICAgcHJvY2Vzcy5lbnZbcHJlZmVycmVkTmFtZV0gPSBwcm9jZXNzLmVudltsZWdhY3lOYW1lXTtcbiAgfVxufVxuIl19