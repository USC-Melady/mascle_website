import { LogLevel, format, printer } from '@aws-amplify/cli-core';
import { AmplifyError } from '@aws-amplify/platform-core';
import { extractSubCommands } from './extract_sub_commands.js';
let hasAttachUnhandledExceptionListenersBeenCalled = false;
/**
 * Attaches process listeners to handle unhandled exceptions and rejections
 */
export const attachUnhandledExceptionListeners = (usageDataEmitter) => {
    if (hasAttachUnhandledExceptionListenersBeenCalled) {
        return;
    }
    process.on('unhandledRejection', (reason) => {
        process.exitCode = 1;
        if (reason instanceof Error) {
            void handleErrorSafe({ error: reason, usageDataEmitter });
        }
        else if (typeof reason === 'string') {
            void handleErrorSafe({ error: new Error(reason), usageDataEmitter });
        }
        else {
            void handleErrorSafe({
                error: new Error(`Unhandled rejection of type [${typeof reason}]`, {
                    cause: reason,
                }),
                usageDataEmitter,
            });
        }
    });
    process.on('uncaughtException', (error) => {
        process.exitCode = 1;
        void handleErrorSafe({ error, usageDataEmitter });
    });
    hasAttachUnhandledExceptionListenersBeenCalled = true;
};
/**
 * Generates a function that is intended to be used as a callback to yargs.fail()
 * All logic for actually handling errors should be delegated to handleError.
 *
 * For some reason the yargs object that is injected into the fail callback does not include all methods on the Argv type
 * This generator allows us to inject the yargs parser into the callback so that we can call parser.exit() from the failure handler
 * This prevents our top-level error handler from being invoked after the yargs error handler has already been invoked
 */
export const generateCommandFailureHandler = (parser, usageDataEmitter) => {
    /**
     * Format error output when a command fails
     * @param message error message set by the yargs:check validations
     * @param error error thrown by yargs handler
     */
    const handleCommandFailure = async (message, error) => {
        const printHelp = () => {
            printer.printNewLine();
            parser.showHelp();
            printer.printNewLine();
        };
        await handleErrorSafe({
            command: extractSubCommands(parser),
            printMessagePreamble: printHelp,
            error,
            message,
            usageDataEmitter,
        });
        parser.exit(1, error || new Error(message));
    };
    return handleCommandFailure;
};
const handleErrorSafe = async (props) => {
    try {
        await handleError(props);
    }
    catch (e) {
        printer.log(format.error(e), LogLevel.DEBUG);
        // no-op should gracefully exit
        return;
    }
};
/**
 * Error handling for uncaught errors during CLI command execution.
 *
 * This should be the one and only place where we handle unexpected errors.
 * This includes console logging, debug logging, metrics recording, etc.
 * (Note that we don't do all of those things yet, but this is where they should go)
 */
const handleError = async ({ error, printMessagePreamble, message, usageDataEmitter, command, }) => {
    // If yargs threw an error because the customer force-closed a prompt (ie Ctrl+C during a prompt) then the intent to exit the process is clear
    if (isUserForceClosePromptError(error)) {
        return;
    }
    printMessagePreamble?.();
    if (AmplifyError.isAmplifyError(error)) {
        printer.print(format.error(`${error.name}: ${error.message}`));
        if (error.resolution) {
            printer.print(`Resolution: ${error.resolution}`);
        }
        if (error.details) {
            printer.print(`Details: ${error.details}`);
        }
        if (errorHasCauseMessage(error)) {
            printer.print(`Cause: ${error.cause.message}`);
        }
    }
    else {
        // non-Amplify Error object
        printer.print(format.error(message || String(error)));
        if (errorHasCauseMessage(error)) {
            printer.print(`Cause: ${error.cause.message}`);
        }
    }
    // additional debug logging for the stack traces
    if (error?.stack) {
        printer.log(error.stack, LogLevel.DEBUG);
    }
    if (errorHasCauseStackTrace(error)) {
        printer.log(error.cause.stack, LogLevel.DEBUG);
    }
    await usageDataEmitter?.emitFailure(AmplifyError.isAmplifyError(error)
        ? error
        : AmplifyError.fromError(error && error instanceof Error ? error : new Error(message)), { command: command ?? 'UnknownCommand' });
};
const isUserForceClosePromptError = (err) => {
    return !!err && err?.message.includes('User force closed the prompt');
};
const errorHasCauseStackTrace = (error) => {
    return (typeof error?.cause === 'object' &&
        !!error.cause &&
        'stack' in error.cause &&
        typeof error.cause.stack === 'string');
};
const errorHasCauseMessage = (error) => {
    return (typeof error?.cause === 'object' &&
        !!error.cause &&
        'message' in error.cause &&
        typeof error.cause.message === 'string');
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXJyb3JfaGFuZGxlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9lcnJvcl9oYW5kbGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBRWxFLE9BQU8sRUFBRSxZQUFZLEVBQW9CLE1BQU0sNEJBQTRCLENBQUM7QUFDNUUsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFFL0QsSUFBSSw4Q0FBOEMsR0FBRyxLQUFLLENBQUM7QUFVM0Q7O0dBRUc7QUFDSCxNQUFNLENBQUMsTUFBTSxpQ0FBaUMsR0FBRyxDQUMvQyxnQkFBa0MsRUFDNUIsRUFBRTtJQUNSLElBQUksOENBQThDLEVBQUU7UUFDbEQsT0FBTztLQUNSO0lBQ0QsT0FBTyxDQUFDLEVBQUUsQ0FBQyxvQkFBb0IsRUFBRSxDQUFDLE1BQU0sRUFBRSxFQUFFO1FBQzFDLE9BQU8sQ0FBQyxRQUFRLEdBQUcsQ0FBQyxDQUFDO1FBQ3JCLElBQUksTUFBTSxZQUFZLEtBQUssRUFBRTtZQUMzQixLQUFLLGVBQWUsQ0FBQyxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsZ0JBQWdCLEVBQUUsQ0FBQyxDQUFDO1NBQzNEO2FBQU0sSUFBSSxPQUFPLE1BQU0sS0FBSyxRQUFRLEVBQUU7WUFDckMsS0FBSyxlQUFlLENBQUMsRUFBRSxLQUFLLEVBQUUsSUFBSSxLQUFLLENBQUMsTUFBTSxDQUFDLEVBQUUsZ0JBQWdCLEVBQUUsQ0FBQyxDQUFDO1NBQ3RFO2FBQU07WUFDTCxLQUFLLGVBQWUsQ0FBQztnQkFDbkIsS0FBSyxFQUFFLElBQUksS0FBSyxDQUFDLGdDQUFnQyxPQUFPLE1BQU0sR0FBRyxFQUFFO29CQUNqRSxLQUFLLEVBQUUsTUFBTTtpQkFDZCxDQUFDO2dCQUNGLGdCQUFnQjthQUNqQixDQUFDLENBQUM7U0FDSjtJQUNILENBQUMsQ0FBQyxD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QUMsS0FBSztRQUNiLE9BQU8sSUFBSSxLQUFLLENBQUMsS0FBSztRQUN0QixPQUFPLEtBQUssQ0FBQyxLQUFLLENBQUMsS0FBSyxLQUFLLFFBQVEsQ0FDdEMsQ0FBQztBQUNKLENBQUMsQ0FBQztBQUVGLE1BQU0sb0JBQW9CLEdBQUcsQ0FDM0IsS0FBYSxFQUNvQyxFQUFFO0lBQ25ELE9BQU8sQ0FDTCxPQUFPLEtBQUssRUFBRSxLQUFLLEtBQUssUUFBUTtRQUNoQyxDQUFDLENBQUMsS0FBSyxDQUFDLEtBQUs7UUFDYixTQUFTLElBQUksS0FBSyxDQUFDLEtBQUs7UUFDeEIsT0FBTyxLQUFLLENBQUMsS0FBSyxDQUFDLE9BQU8sS0FBSyxRQUFRLENBQ3hDLENBQUM7QUFDSixDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBMb2dMZXZlbCwgZm9ybWF0LCBwcmludGVyIH0gZnJvbSAnQGF3cy1hbXBsaWZ5L2NsaS1jb3JlJztcbmltcG9ydCB7IEFyZ3YgfSBmcm9tICd5YXJncyc7XG5pbXBvcnQgeyBBbXBsaWZ5RXJyb3IsIFVzYWdlRGF0YUVtaXR0ZXIgfSBmcm9tICdAYXdzLWFtcGxpZnkvcGxhdGZvcm0tY29yZSc7XG5pbXBvcnQgeyBleHRyYWN0U3ViQ29tbWFuZHMgfSBmcm9tICcuL2V4dHJhY3Rfc3ViX2NvbW1hbmRzLmpzJztcblxubGV0IGhhc0F0dGFjaFVuaGFuZGxlZEV4Y2VwdGlvbkxpc3RlbmVyc0JlZW5DYWxsZWQgPSBmYWxzZTtcblxudHlwZSBIYW5kbGVFcnJvclByb3BzID0ge1xuICBlcnJvcj86IEVycm9yO1xuICBwcmludE1lc3NhZ2VQcmVhbWJsZT86ICgpID0+IHZvaWQ7XG4gIG1lc3NhZ2U/OiBzdHJpbmc7XG4gIHVzYWdlRGF0YUVtaXR0ZXI/OiBVc2FnZURhdGFFbWl0dGVyO1xuICBjb21tYW5kPzogc3RyaW5nO1xufTtcblxuLyoqXG4gKiBBdHRhY2hlcyBwcm9jZXNzIGxpc3RlbmVycyB0byBoYW5kbGUgdW5oYW5kbGVkIGV4Y2VwdGlvbnMgYW5kIHJlamVjdGlvbnNcbiAqL1xuZXhwb3J0IGNvbnN0IGF0dGFjaFVuaGFuZGxlZEV4Y2VwdGlvbkxpc3RlbmVycyA9IChcbiAgdXNhZ2VEYXRhRW1pdHRlcjogVXNhZ2VEYXRhRW1pdHRlcixcbik6IHZvaWQgPT4ge1xuICBpZiAoaGFzQXR0YWNoVW5oYW5kbGVkRXhjZXB0aW9uTGlzdGVuZXJzQmVlbkNhbGxlZCkge1xuICAgIHJldHVybjtcbiAgfVxuICBwcm9jZXNzLm9uKCd1bmhhbmRsZWRSZWplY3Rpb24nLCAocmVhc29uKSA9PiB7XG4gICAgcHJvY2Vzcy5leGl0Q29kZSA9IDE7XG4gICAgaWYgKHJlYXNvbiBpbnN0YW5jZW9mIEVycm9yKSB7XG4gICAgICB2b2lkIGhhbmRsZUVycm9yU2FmZSh7IGVycm9yOiByZWFzb24sIHVzYWdlRGF0YUVtaXR0ZXIgfSk7XG4gICAgfSBlbHNlIGlmICh0eXBlb2YgcmVhc29uID09PSAnc3RyaW5nJykge1xuICAgICAgdm9pZCBoYW5kbGVFcnJvclNhZmUoeyBlcnJvcjogbmV3IEVycm9yKHJlYXNvbiksIHVzYWdlRGF0YUVtaXR0ZXIgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHZvaWQgaGFuZGxlRXJyb3JTYWZlKHtcbiAgICAgICAgZXJyb3I6IG5ldyBFcnJvcihgVW5oYW5kbGVkIHJlamVjdGlvbiBvZiB0eXBlIFske3R5cGVvZiByZWFzb259XWAsIHtcbiAgICAgICAgICBjYXVzZTogcmVhc29uLFxuICAgICAgICB9KSxcbiAgICAgICAgdXNhZ2VEYXRhRW1pdHRlcixcbiAgICAgIH0pO1xuICAgIH1cbiAgfSk7XG5cbiAgcHJvY2Vzcy5vbigndW5jYXVnaHRFeGNlcHRpb24nLCAoZXJyb3IpID0+IHtcbiAgICBwcm9jZXNzLmV4aXRDb2RlID0gMTtcbiAgICB2b2lkIGhhbmRsZUVycm9yU2FmZSh7IGVycm9yLCB1c2FnZURhdGFFbWl0dGVyIH0pO1xuICB9KTtcbiAgaGFzQXR0YWNoVW5oYW5kbGVkRXhjZXB0aW9uTGlzdGVuZXJzQmVlbkNhbGxlZCA9IHRydWU7XG59O1xuXG4vKipcbiAqIEdlbmVyYXRlcyBhIGZ1bmN0aW9uIHRoYXQgaXMgaW50ZW5kZWQgdG8gYmUgdXNlZCBhcyBhIGNhbGxiYWNrIHRvIHlhcmdzLmZhaWwoKVxuICogQWxsIGxvZ2ljIGZvciBhY3R1YWxseSBoYW5kbGluZyBlcnJvcnMgc2hvdWxkIGJlIGRlbGVnYXRlZCB0byBoYW5kbGVFcnJvci5cbiAqXG4gKiBGb3Igc29tZSByZWFzb24gdGhlIHlhcmdzIG9iamVjdCB0aGF0IGlzIGluamVjdGVkIGludG8gdGhlIGZhaWwgY2FsbGJhY2sgZG9lcyBub3QgaW5jbHVkZSBhbGwgbWV0aG9kcyBvbiB0aGUgQXJndiB0eXBlXG4gKiBUaGlzIGdlbmVyYXRvciBhbGxvd3MgdXMgdG8gaW5qZWN0IHRoZSB5YXJncyBwYXJzZXIgaW50byB0aGUgY2FsbGJhY2sgc28gdGhhdCB3ZSBjYW4gY2FsbCBwYXJzZXIuZXhpdCgpIGZyb20gdGhlIGZhaWx1cmUgaGFuZGxlclxuICogVGhpcyBwcmV2ZW50cyBvdXIgdG9wLWxldmVsIGVycm9yIGhhbmRsZXIgZnJvbSBiZWluZyBpbnZva2VkIGFmdGVyIHRoZSB5YXJncyBlcnJvciBoYW5kbGVyIGhhcyBhbHJlYWR5IGJlZW4gaW52b2tlZFxuICovXG5leHBvcnQgY29uc3QgZ2VuZXJhdGVDb21tYW5kRmFpbHVyZUhhbmRsZXIgPSAoXG4gIHBhcnNlcjogQXJndixcbiAgdXNhZ2VEYXRhRW1pdHRlcj86IFVzYWdlRGF0YUVtaXR0ZXIsXG4pOiAoKG1lc3NhZ2U6IHN0cmluZywgZXJyb3I6IEVycm9yKSA9PiBQcm9taXNlPHZvaWQ+KSA9PiB7XG4gIC8qKlxuICAgKiBGb3JtYXQgZXJyb3Igb3V0cHV0IHdoZW4gYSBjb21tYW5kIGZhaWxzXG4gICAqIEBwYXJhbSBtZXNzYWdlIGVycm9yIG1lc3NhZ2Ugc2V0IGJ5IHRoZSB5YXJnczpjaGVjayB2YWxpZGF0aW9uc1xuICAgKiBAcGFyYW0gZXJyb3IgZXJyb3IgdGhyb3duIGJ5IHlhcmdzIGhhbmRsZXJcbiAgICovXG4gIGNvbnN0IGhhbmRsZUNvbW1hbmRGYWlsdXJlID0gYXN5bmMgKG1lc3NhZ2U6IHN0cmluZywgZXJyb3I/OiBFcnJvcikgPT4ge1xuICAgIGNvbnN0IHByaW50SGVscCA9ICgpID0+IHtcbiAgICAgIHByaW50ZXIucHJpbnROZXdMaW5lKCk7XG4gICAgICBwYXJzZXIuc2hvd0hlbHAoKTtcbiAgICAgIHByaW50ZXIucHJpbnROZXdMaW5lKCk7XG4gICAgfTtcbiAgICBhd2FpdCBoYW5kbGVFcnJvclNhZmUoe1xuICAgICAgY29tbWFuZDogZXh0cmFjdFN1YkNvbW1hbmRzKHBhcnNlciksXG4gICAgICBwcmludE1lc3NhZ2VQcmVhbWJsZTogcHJpbnRIZWxwLFxuICAgICAgZXJyb3IsXG4gICAgICBtZXNzYWdlLFxuICAgICAgdXNhZ2VEYXRhRW1pdHRlcixcbiAgICB9KTtcbiAgICBwYXJzZXIuZXhpdCgxLCBlcnJvciB8fCBuZXcgRXJyb3IobWVzc2FnZSkpO1xuICB9O1xuICByZXR1cm4gaGFuZGxlQ29tbWFuZEZhaWx1cmU7XG59O1xuXG5jb25zdCBoYW5kbGVFcnJvclNhZmUgPSBhc3luYyAocHJvcHM6IEhhbmRsZUVycm9yUHJvcHMpID0+IHtcbiAgdHJ5IHtcbiAgICBhd2FpdCBoYW5kbGVFcnJvcihwcm9wcyk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBwcmludGVyLmxvZyhmb3JtYXQuZXJyb3IoZSksIExvZ0xldmVsLkRFQlVHKTtcbiAgICAvLyBuby1vcCBzaG91bGQgZ3JhY2VmdWxseSBleGl0XG4gICAgcmV0dXJuO1xuICB9XG59O1xuXG4vKipcbiAqIEVycm9yIGhhbmRsaW5nIGZvciB1bmNhdWdodCBlcnJvcnMgZHVyaW5nIENMSSBjb21tYW5kIGV4ZWN1dGlvbi5cbiAqXG4gKiBUaGlzIHNob3VsZCBiZSB0aGUgb25lIGFuZCBvbmx5IHBsYWNlIHdoZXJlIHdlIGhhbmRsZSB1bmV4cGVjdGVkIGVycm9ycy5cbiAqIFRoaXMgaW5jbHVkZXMgY29uc29sZSBsb2dnaW5nLCBkZWJ1ZyBsb2dnaW5nLCBtZXRyaWNzIHJlY29yZGluZywgZXRjLlxuICogKE5vdGUgdGhhdCB3ZSBkb24ndCBkbyBhbGwgb2YgdGhvc2UgdGhpbmdzIHlldCwgYnV0IHRoaXMgaXMgd2hlcmUgdGhleSBzaG91bGQgZ28pXG4gKi9cbmNvbnN0IGhhbmRsZUVycm9yID0gYXN5bmMgKHtcbiAgZXJyb3IsXG4gIHByaW50TWVzc2FnZVByZWFtYmxlLFxuICBtZXNzYWdlLFxuICB1c2FnZURhdGFFbWl0dGVyLFxuICBjb21tYW5kLFxufTogSGFuZGxlRXJyb3JQcm9wcykgPT4ge1xuICAvLyBJZiB5YXJncyB0aHJldyBhbiBlcnJvciBiZWNhdXNlIHRoZSBjdXN0b21lciBmb3JjZS1jbG9zZWQgYSBwcm9tcHQgKGllIEN0cmwrQyBkdXJpbmcgYSBwcm9tcHQpIHRoZW4gdGhlIGludGVudCB0byBleGl0IHRoZSBwcm9jZXNzIGlzIGNsZWFyXG4gIGlmIChpc1VzZXJGb3JjZUNsb3NlUHJvbXB0RXJyb3IoZXJyb3IpKSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgcHJpbnRNZXNzYWdlUHJlYW1ibGU/LigpO1xuXG4gIGlmIChBbXBsaWZ5RXJyb3IuaXNBbXBsaWZ5RXJyb3IoZXJyb3IpKSB7XG4gICAgcHJpbnRlci5wcmludChmb3JtYXQuZXJyb3IoYCR7ZXJyb3IubmFtZX06ICR7ZXJyb3IubWVzc2FnZX1gKSk7XG5cbiAgICBpZiAoZXJyb3IucmVzb2x1dGlvbikge1xuICAgICAgcHJpbnRlci5wcmludChgUmVzb2x1dGlvbjogJHtlcnJvci5yZXNvbHV0aW9ufWApO1xuICAgIH1cbiAgICBpZiAoZXJyb3IuZGV0YWlscykge1xuICAgICAgcHJpbnRlci5wcmludChgRGV0YWlsczogJHtlcnJvci5kZXRhaWxzfWApO1xuICAgIH1cbiAgICBpZiAoZXJyb3JIYXNDYXVzZU1lc3NhZ2UoZXJyb3IpKSB7XG4gICAgICBwcmludGVyLnByaW50KGBDYXVzZTogJHtlcnJvci5jYXVzZS5tZXNzYWdlfWApO1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICAvLyBub24tQW1wbGlmeSBFcnJvciBvYmplY3RcbiAgICBwcmludGVyLnByaW50KGZvcm1hdC5lcnJvcihtZXNzYWdlIHx8IFN0cmluZyhlcnJvcikpKTtcblxuICAgIGlmIChlcnJvckhhc0NhdXNlTWVzc2FnZShlcnJvcikpIHtcbiAgICAgIHByaW50ZXIucHJpbnQoYENhdXNlOiAke2Vycm9yLmNhdXNlLm1lc3NhZ2V9YCk7XG4gICAgfVxuICB9XG5cbiAgLy8gYWRkaXRpb25hbCBkZWJ1ZyBsb2dnaW5nIGZvciB0aGUgc3RhY2sgdHJhY2VzXG4gIGlmIChlcnJvcj8uc3RhY2spIHtcbiAgICBwcmludGVyLmxvZyhlcnJvci5zdGFjaywgTG9nTGV2ZWwuREVCVUcpO1xuICB9XG4gIGlmIChlcnJvckhhc0NhdXNlU3RhY2tUcmFjZShlcnJvcikpIHtcbiAgICBwcmludGVyLmxvZyhlcnJvci5jYXVzZS5zdGFjaywgTG9nTGV2ZWwuREVCVUcpO1xuICB9XG5cbiAgYXdhaXQgdXNhZ2VEYXRhRW1pdHRlcj8uZW1pdEZhaWx1cmUoXG4gICAgQW1wbGlmeUVycm9yLmlzQW1wbGlmeUVycm9yKGVycm9yKVxuICAgICAgPyBlcnJvclxuICAgICAgOiBBbXBsaWZ5RXJyb3IuZnJvbUVycm9yKFxuICAgICAgICAgIGVycm9yICYmIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvciA6IG5ldyBFcnJvcihtZXNzYWdlKSxcbiAgICAgICAgKSxcbiAgICB7IGNvbW1hbmQ6IGNvbW1hbmQgPz8gJ1Vua25vd25Db21tYW5kJyB9LFxuICApO1xufTtcblxuY29uc3QgaXNVc2VyRm9yY2VDbG9zZVByb21wdEVycm9yID0gKGVycj86IEVycm9yKTogYm9vbGVhbiA9PiB7XG4gIHJldHVybiAhIWVyciAmJiBlcnI/Lm1lc3NhZ2UuaW5jbHVkZXMoJ1VzZXIgZm9yY2UgY2xvc2VkIHRoZSBwcm9tcHQnKTtcbn07XG5cbmNvbnN0IGVycm9ySGFzQ2F1c2VTdGFja1RyYWNlID0gKFxuICBlcnJvcj86IEVycm9yLFxuKTogZXJyb3IgaXMgRXJyb3IgJiB7IGNhdXNlOiB7IHN0YWNrOiBzdHJpbmcgfSB9ID0+IHtcbiAgcmV0dXJuIChcbiAgICB0eXBlb2YgZXJyb3I/LmNhdXNlID09PSAnb2JqZWN0JyAmJlxuICAgICEhZXJyb3IuY2F1c2UgJiZcbiAgICAnc3RhY2snIGluIGVycm9yLmNhdXNlICYmXG4gICAgdHlwZW9mIGVycm9yLmNhdXNlLnN0YWNrID09PSAnc3RyaW5nJ1xuICApO1xufTtcblxuY29uc3QgZXJyb3JIYXNDYXVzZU1lc3NhZ2UgPSAoXG4gIGVycm9yPzogRXJyb3IsXG4pOiBlcnJvciBpcyBFcnJvciAmIHsgY2F1c2U6IHsgbWVzc2FnZTogc3RyaW5nIH0gfSA9PiB7XG4gIHJldHVybiAoXG4gICAgdHlwZW9mIGVycm9yPy5jYXVzZSA9PT0gJ29iamVjdCcgJiZcbiAgICAhIWVycm9yLmNhdXNlICYmXG4gICAgJ21lc3NhZ2UnIGluIGVycm9yLmNhdXNlICYmXG4gICAgdHlwZW9mIGVycm9yLmNhdXNlLm1lc3NhZ2UgPT09ICdzdHJpbmcnXG4gICk7XG59O1xuIl19