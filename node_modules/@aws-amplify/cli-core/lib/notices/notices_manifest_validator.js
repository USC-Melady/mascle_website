import semver from 'semver';
import { AmplifyFault } from '@aws-amplify/platform-core';
/**
 * Validates the notices manifest.
 */
export class NoticesManifestValidator {
    props;
    _fetch;
    /**
     * Creates notices manifest validator.
     */
    constructor(props, _fetch = fetch) {
        this.props = props;
        this._fetch = _fetch;
    }
    validate = async (noticesManifest) => {
        const ids = new Set();
        for (const notice of noticesManifest.notices) {
            await this.validateNotice(notice);
            if (ids.has(notice.id)) {
                throw new AmplifyFault('InvalidNoticeManifestFault', {
                    message: `Notice ids must be unique. ${notice.id} is duplicated.`,
                });
            }
            ids.add(notice.id);
        }
    };
    validateNotice = async (notice) => {
        if (notice.link) {
            const gitHubIssueLinkPattern = /^https:\/\/github.com\/aws-amplify\/amplify-backend\/issues\/(?<issueNumber>\d+)$/;
            const matched = notice.link.match(gitHubIssueLinkPattern);
            if (!matched) {
                throw new AmplifyFault('InvalidNoticeManifestFault', {
                    message: `Link must match ${gitHubIssueLinkPattern.source}`,
                });
            }
            if (matched.groups?.issueNumber !== notice.id) {
                throw new AmplifyFault('InvalidNoticeManifestFault', {
                    message: 'Notice id must be equal to GitHub issue number if link is provided',
                });
            }
            if (this.props?.checkLinksWithGitHubApi) {
                const issueNumber = matched.groups.issueNumber;
                const response = await this._fetch(`https://api.github.com/repos/aws-amplify/amplify-backend/issues/${issueNumber}`);
                if (!response.ok) {
                    throw new AmplifyFault('InvalidNoticeManifestFault', {
                        message: 'Notice link must point to valid notice',
                    });
                }
            }
        }
        // Special validations not covered by zod schema.
        for (const predicate of notice.predicates) {
            if (predicate.type === 'packageVersion') {
                if (!semver.validRange(predicate.versionRange)) {
                    throw new AmplifyFault('InvalidNoticeManifestFault', {
                        message: 'Package version predicate must have a valid version range',
                    });
                }
            }
            else if (predicate.type === 'nodeVersion') {
                if (!semver.validRange(predicate.versionRange)) {
                    throw new AmplifyFault('InvalidNoticeManifestFault', {
                        message: 'Node version predicate must have a valid version range',
                    });
                }
            }
        }
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibm90aWNlc19tYW5pZmVzdF92YWxpZGF0b3IuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvbm90aWNlcy9ub3RpY2VzX21hbmlmZXN0X3ZhbGlkYXRvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLE1BQU0sTUFBTSxRQUFRLENBQUM7QUFDNUIsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBTTFEOztHQUVHO0FBQ0gsTUFBTSxPQUFPLHdCQUF3QjtJQUtoQjtJQUNBO0lBTG5COztPQUVHO0lBQ0gsWUFDbUIsS0FBcUMsRUFDckMsU0FBUyxLQUFLO1FBRGQsVUFBSyxHQUFMLEtBQUssQ0FBZ0M7UUFDckMsV0FBTSxHQUFOLE1BQU0sQ0FBUTtJQUM5QixDQUFDO0lBRUosUUFBUSxHQUFHLEtBQUssRUFBRSxlQUFnQyxFQUFpQixFQUFFO1FBQ25FLE1BQU0sR0FBRyxHQUFHLElBQUksR0FBRyxFQUFVLENBQUM7UUFDOUIsS0FBSyxNQUFNLE1BQU0sSUFBSSxlQUFlLENBQUMsT0FBTyxFQUFFO1lBQzVDLE1BQU0sSUFBSSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUNsQyxJQUFJLEdBQUcsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxFQUFFO2dCQUN0QixNQUFNLElBQUksWUFBWSxDQUFDLDRCQUE0QixFQUFFO29CQUNuRCxPQUFPLEVBQUUsOEJBQThCLE1BQU0sQ0FBQyxFQUFFLGlCQUFpQjtpQkFDbEUsQ0FBQyxDQUFDO2FBQ0o7WUFDRCxHQUFHLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztTQUNwQjtJQUNILENBQUMsQ0FBQztJQUVNLGNBQWMsR0FBRyxLQUFLLEVBQUUsTUFBYyxFQUFpQixFQUFFO1FBQy9ELElBQUksTUFBTSxDQUFDLElBQUksRUFBRTtZQUNmLE1BQU0sc0JBQXNCLEdBQzFCLG1GQUFtRixDQUFDO1lBQ3RGLE1BQU0sT0FBTyxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLHNCQUFzQixDQUFDLENBQUM7WUFDMUQsSUFBSSxDQUFDLE9BQU8sRUFBRTtnQkFDWixNQUFNLElBQUksWUFBWSxDQUFDLDRCQUE0QixFQUFFO29CQUNuRCxPQUFPLEVBQUUsbUJBQW1CLHNCQUFzQixDQUFDLE1BQU0sRUFBRTtpQkFDNUQsQ0FBQyxDQUFDO2FBQ0o7WUFDRCxJQUFJLE9BQU8sQ0FBQyxNQUFNLEVBQUUsV0FBVyxLQUFLLE1BQU0sQ0FBQyxFQUFFLEVBQUU7Z0JBQzdDLE1BQU0sSUFBSSxZQUFZLENBQUMsNEJBQTRCLEVBQUU7b0JBQ25ELE9BQU8sRUFDTCxvRUFBb0U7aUJBQ3ZFLENBQUMsQ0FBQzthQUNKO1lBQ0QsSUFBSSxJQUFJLENBQUMsS0FBSyxFQUFFLHVCQUF1QixFQUFFO2dCQUN2QyxNQUFNLFdBQVcsR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQztnQkFDL0MsTUFBTSxRQUFRLEdBQUcsTUFBTSxJQUFJLENBQUMsTUFBTSxDQUNoQyxtRUFBbUUsV0FBVyxFQUFFLENBQ2pGLENBQUM7Z0JBQ0YsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLEVBQUU7b0JBQ2hCLE1BQU0sSUFBSSxZQUFZLENBQUMsNEJBQTRCLEVBQUU7d0JBQ25ELE9BQU8sRUFBRSx3Q0FBd0M7cUJBQ2xELENBQUMsQ0FBQztpQkFDSjthQUNGO1NBQ0Y7UUFFRCxpREFBaUQ7UUFDakQsS0FBSyxNQUFNLFNBQVMsSUFBSSxNQUFNLENBQUMsVUFBVSxFQUFFO1lBQ3pDLElBQUksU0FBUyxDQUFDLElBQUksS0FBSyxnQkFBZ0IsRUFBRTtnQkFDdkMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsU0FBUyxDQUFDLFlBQVksQ0FBQyxFQUFFO29CQUM5QyxNQUFNLElBQUksWUFBWSxDQUFDLDRCQUE0QixFQUFFO3dCQUNuRCxPQUFPLEVBQ0wsMkRBQTJEO3FCQUM5RCxDQUFDLENBQUM7aUJBQ0o7YUFDRjtpQkFBTSxJQUFJLFNBQVMsQ0FBQyxJQUFJLEtBQUssYUFBYSxFQUFFO2dCQUMzQyxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsWUFBWSxDQUFDLEVBQUU7b0JBQzlDLE1BQU0sSUFBSSxZQUFZLENBQUMsNEJBQTRCLEVBQUU7d0JBQ25ELE9BQU8sRUFBRSx3REFBd0Q7cUJBQ2xFLENBQUMsQ0FBQztpQkFDSjthQUNGO1NBQ0Y7SUFDSCxDQUFDLENBQUM7Q0FDSCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE5vdGljZSwgTm90aWNlc01hbmlmZXN0IH0gZnJvbSAnLi9ub3RpY2VzLmpzJztcbmltcG9ydCBzZW12ZXIgZnJvbSAnc2VtdmVyJztcbmltcG9ydCB7IEFtcGxpZnlGYXVsdCB9IGZyb20gJ0Bhd3MtYW1wbGlmeS9wbGF0Zm9ybS1jb3JlJztcblxuZXhwb3J0IHR5cGUgTm90aWNlc01hbmlmZXN0VmFsaWRhdG9yUHJvcHMgPSB7XG4gIGNoZWNrTGlua3NXaXRoR2l0SHViQXBpPzogYm9vbGVhbjtcbn07XG5cbi8qKlxuICogVmFsaWRhdGVzIHRoZSBub3RpY2VzIG1hbmlmZXN0LlxuICovXG5leHBvcnQgY2xhc3MgTm90aWNlc01hbmlmZXN0VmFsaWRhdG9yIHtcbiAgLyoqXG4gICAqIENyZWF0ZXMgbm90aWNlcyBtYW5pZmVzdCB2YWxpZGF0b3IuXG4gICAqL1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IHByb3BzPzogTm90aWNlc01hbmlmZXN0VmFsaWRhdG9yUHJvcHMsXG4gICAgcHJpdmF0ZSByZWFkb25seSBfZmV0Y2ggPSBmZXRjaCxcbiAgKSB7fVxuXG4gIHZhbGlkYXRlID0gYXN5bmMgKG5vdGljZXNNYW5pZmVzdDogTm90aWNlc01hbmlmZXN0KTogUHJvbWlzZTx2b2lkPiA9PiB7XG4gICAgY29uc3QgaWRzID0gbmV3IFNldDxzdHJpbmc+KCk7XG4gICAgZm9yIChjb25zdCBub3RpY2Ugb2Ygbm90aWNlc01hbmlmZXN0Lm5vdGljZXMpIHtcbiAgICAgIGF3YWl0IHRoaXMudmFsaWRhdGVOb3RpY2Uobm90aWNlKTtcbiAgICAgIGlmIChpZHMuaGFzKG5vdGljZS5pZCkpIHtcbiAgICAgICAgdGhyb3cgbmV3IEFtcGxpZnlGYXVsdCgnSW52YWxpZE5vdGljZU1hbmlmZXN0RmF1bHQnLCB7XG4gICAgICAgICAgbWVzc2FnZTogYE5vdGljZSBpZHMgbXVzdCBiZSB1bmlxdWUuICR7bm90aWNlLmlkfSBpcyBkdXBsaWNhdGVkLmAsXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgICAgaWRzLmFkZChub3RpY2UuaWQpO1xuICAgIH1cbiAgfTtcblxuICBwcml2YXRlIHZhbGlkYXRlTm90aWNlID0gYXN5bmMgKG5vdGljZTogTm90aWNlKTogUHJvbWlzZTx2b2lkPiA9PiB7XG4gICAgaWYgKG5vdGljZS5saW5rKSB7XG4gICAgICBjb25zdCBnaXRIdWJJc3N1ZUxpbmtQYXR0ZXJuID1cbiAgICAgICAgL15odHRwczpcXC9cXC9naXRodWIuY29tXFwvYXdzLWFtcGxpZnlcXC9hbXBsaWZ5LWJhY2tlbmRcXC9pc3N1ZXNcXC8oPzxpc3N1ZU51bWJlcj5cXGQrKSQvO1xuICAgICAgY29uc3QgbWF0Y2hlZCA9IG5vdGljZS5saW5rLm1hdGNoKGdpdEh1Yklzc3VlTGlua1BhdHRlcm4pO1xuICAgICAgaWYgKCFtYXRjaGVkKSB7XG4gICAgICAgIHRocm93IG5ldyBBbXBsaWZ5RmF1bHQoJ0ludmFsaWROb3RpY2VNYW5pZmVzdEZhdWx0Jywge1xuICAgICAgICAgIG1lc3NhZ2U6IGBMaW5rIG11c3QgbWF0Y2ggJHtnaXRIdWJJc3N1ZUxpbmtQYXR0ZXJuLnNvdXJjZX1gLFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICAgIGlmIChtYXRjaGVkLmdyb3Vwcz8uaXNzdWVOdW1iZXIgIT09IG5vdGljZS5pZCkge1xuICAgICAgICB0aHJvdyBuZXcgQW1wbGlmeUZhdWx0KCdJbnZhbGlkTm90aWNlTWFuaWZlc3RGYXVsdCcsIHtcbiAgICAgICAgICBtZXNzYWdlOlxuICAgICAgICAgICAgJ05vdGljZSBpZCBtdXN0IGJlIGVxdWFsIHRvIEdpdEh1YiBpc3N1ZSBudW1iZXIgaWYgbGluayBpcyBwcm92aWRlZCcsXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgICAgaWYgKHRoaXMucHJvcHM/LmNoZWNrTGlua3NXaXRoR2l0SHViQXBpKSB7XG4gICAgICAgIGNvbnN0IGlzc3VlTnVtYmVyID0gbWF0Y2hlZC5ncm91cHMuaXNzdWVOdW1iZXI7XG4gICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5fZmV0Y2goXG4gICAgICAgICAgYGh0dHBzOi8vYXBpLmdpdGh1Yi5jb20vcmVwb3MvYXdzLWFtcGxpZnkvYW1wbGlmeS1iYWNrZW5kL2lzc3Vlcy8ke2lzc3VlTnVtYmVyfWAsXG4gICAgICAgICk7XG4gICAgICAgIGlmICghcmVzcG9uc2Uub2spIHtcbiAgICAgICAgICB0aHJvdyBuZXcgQW1wbGlmeUZhdWx0KCdJbnZhbGlkTm90aWNlTWFuaWZlc3RGYXVsdCcsIHtcbiAgICAgICAgICAgIG1lc3NhZ2U6ICdOb3RpY2UgbGluayBtdXN0IHBvaW50IHRvIHZhbGlkIG5vdGljZScsXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBTcGVjaWFsIHZhbGlkYXRpb25zIG5vdCBjb3ZlcmVkIGJ5IHpvZCBzY2hlbWEuXG4gICAgZm9yIChjb25zdCBwcmVkaWNhdGUgb2Ygbm90aWNlLnByZWRpY2F0ZXMpIHtcbiAgICAgIGlmIChwcmVkaWNhdGUudHlwZSA9PT0gJ3BhY2thZ2VWZXJzaW9uJykge1xuICAgICAgICBpZiAoIXNlbXZlci52YWxpZFJhbmdlKHByZWRpY2F0ZS52ZXJzaW9uUmFuZ2UpKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEFtcGxpZnlGYXVsdCgnSW52YWxpZE5vdGljZU1hbmlmZXN0RmF1bHQnLCB7XG4gICAgICAgICAgICBtZXNzYWdlOlxuICAgICAgICAgICAgICAnUGFja2FnZSB2ZXJzaW9uIHByZWRpY2F0ZSBtdXN0IGhhdmUgYSB2YWxpZCB2ZXJzaW9uIHJhbmdlJyxcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIGlmIChwcmVkaWNhdGUudHlwZSA9PT0gJ25vZGVWZXJzaW9uJykge1xuICAgICAgICBpZiAoIXNlbXZlci52YWxpZFJhbmdlKHByZWRpY2F0ZS52ZXJzaW9uUmFuZ2UpKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEFtcGxpZnlGYXVsdCgnSW52YWxpZE5vdGljZU1hbmlmZXN0RmF1bHQnLCB7XG4gICAgICAgICAgICBtZXNzYWdlOiAnTm9kZSB2ZXJzaW9uIHByZWRpY2F0ZSBtdXN0IGhhdmUgYSB2YWxpZCB2ZXJzaW9uIHJhbmdlJyxcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfTtcbn1cbiJdfQ==