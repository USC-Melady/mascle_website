import fsp from 'fs/promises';
import path from 'path';
import z from 'zod';
import { printer } from '../../printer.js';
import { LogLevel } from '../../printer/printer.js';
/**
 * NpmLockFileReader is an abstraction around the logic used to read and parse lock file contents
 */
export class NpmLockFileReader {
    getLockFileContentsFromCwd = async () => {
        const dependencies = [];
        const packageLockJsonPath = path.resolve(process.cwd(), 'package-lock.json');
        let packageLockJson;
        try {
            const jsonLockContents = await fsp.readFile(packageLockJsonPath, 'utf-8');
            const jsonLockParsedValue = JSON.parse(jsonLockContents);
            // This will strip fields that are not part of the package lock schema
            packageLockJson = packageLockJsonSchema.parse(jsonLockParsedValue);
        }
        catch {
            printer.log(`Failed to get lock file contents because ${packageLockJsonPath} does not exist or is not parse-able`, LogLevel.DEBUG);
            return;
        }
        for (const key in packageLockJson.packages) {
            if (key === '') {
                // Skip root project in packages
                continue;
            }
            const dependencyVersion = packageLockJson.packages[key].version;
            // Version may not exist if package is a symbolic link
            if (dependencyVersion) {
                // Remove "node_modules/" prefix
                const dependencyName = key.replace(/^node_modules\//, '');
                dependencies.push({
                    name: dependencyName,
                    version: dependencyVersion,
                });
            }
        }
        return { dependencies };
    };
}
const packageLockJsonSchema = z.object({
    packages: z
        .record(z.string(), z.object({
        version: z.string().optional(),
    }))
        .optional(),
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibnBtX2xvY2tfZmlsZV9yZWFkZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvcGFja2FnZS1tYW5hZ2VyLWNvbnRyb2xsZXIvbG9jay1maWxlLXJlYWRlci9ucG1fbG9ja19maWxlX3JlYWRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEdBQUcsTUFBTSxhQUFhLENBQUM7QUFDOUIsT0FBTyxJQUFJLE1BQU0sTUFBTSxDQUFDO0FBQ3hCLE9BQU8sQ0FBQyxNQUFNLEtBQUssQ0FBQztBQUVwQixPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDM0MsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBRXBEOztHQUVHO0FBQ0gsTUFBTSxPQUFPLGlCQUFpQjtJQUM1QiwwQkFBMEIsR0FBRyxLQUFLLElBRWhDLEVBQUU7UUFDRixNQUFNLFlBQVksR0FBc0IsRUFBRSxDQUFDO1FBQzNDLE1BQU0sbUJBQW1CLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FDdEMsT0FBTyxDQUFDLEdBQUcsRUFBRSxFQUNiLG1CQUFtQixDQUNwQixDQUFDO1FBQ0YsSUFBSSxlQUFlLENBQUM7UUFDcEIsSUFBSTtZQUNGLE1BQU0sZ0JBQWdCLEdBQUcsTUFBTSxHQUFHLENBQUMsUUFBUSxDQUFDLG1CQUFtQixFQUFFLE9BQU8sQ0FBQyxDQUFDO1lBQzFFLE1BQU0sbUJBQW1CLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1lBQ3pELHNFQUFzRTtZQUN0RSxlQUFlLEdBQUcscUJBQXFCLENBQUMsS0FBSyxDQUFDLG1CQUFtQixDQUFDLENBQUM7U0FDcEU7UUFBQyxNQUFNO1lBQ04sT0FBTyxDQUFDLEdBQUcsQ0FDVCw0Q0FBNEMsbUJBQW1CLHNDQUFzQyxFQUNyRyxRQUFRLENBQUMsS0FBSyxDQUNmLENBQUM7WUFDRixPQUFPO1NBQ1I7UUFFRCxLQUFLLE1BQU0sR0FBRyxJQUFJLGVBQWUsQ0FBQyxRQUFRLEVBQUU7WUFDMUMsSUFBSSxHQUFHLEtBQUssRUFBRSxFQUFFO2dCQUNkLGdDQUFnQztnQkFDaEMsU0FBUzthQUNWO1lBQ0QsTUFBTSxpQkFBaUIsR0FBRyxlQUFlLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLE9BQU8sQ0FBQztZQUVoRSxzREFBc0Q7WUFDdEQsSUFBSSxpQkFBaUIsRUFBRTtnQkFDckIsZ0NBQWdDO2dCQUNoQyxNQUFNLGNBQWMsR0FBRyxHQUFHLENBQUMsT0FBTyxDQUFDLGlCQUFpQixFQUFFLEVBQUUsQ0FBQyxDQUFDO2dCQUMxRCxZQUFZLENBQUMsSUFBSSxDQUFDO29CQUNoQixJQUFJLEVBQUUsY0FBYztvQkFDcEIsT0FBTyxFQUFFLGlCQUFpQjtpQkFDM0IsQ0FBQyxDQUFDO2FBQ0o7U0FDRjtRQUVELE9BQU8sRUFBRSxZQUFZLEVBQUUsQ0FBQztJQUMxQixDQUFDLENBQUM7Q0FDSDtBQUVELE1BQU0scUJBQXFCLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQztJQUNyQyxRQUFRLEVBQUUsQ0FBQztTQUNSLE1BQU0sQ0FDTCxDQUFDLENBQUMsTUFBTSxFQUFFLEVBQ1YsQ0FBQyxDQUFDLE1BQU0sQ0FBQztRQUNQLE9BQU8sRUFBRSxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsUUFBUSxFQUFFO0tBQy9CLENBQUMsQ0FDSDtTQUNBLFFBQVEsRUFBRTtDQUNkLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERlcGVuZGVuY3kgfSBmcm9tICdAYXdzLWFtcGxpZnkvcGx1Z2luLXR5cGVzJztcbmltcG9ydCBmc3AgZnJvbSAnZnMvcHJvbWlzZXMnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeiBmcm9tICd6b2QnO1xuaW1wb3J0IHsgTG9ja0ZpbGVDb250ZW50cywgTG9ja0ZpbGVSZWFkZXIgfSBmcm9tICcuL3R5cGVzLmpzJztcbmltcG9ydCB7IHByaW50ZXIgfSBmcm9tICcuLi8uLi9wcmludGVyLmpzJztcbmltcG9ydCB7IExvZ0xldmVsIH0gZnJvbSAnLi4vLi4vcHJpbnRlci9wcmludGVyLmpzJztcblxuLyoqXG4gKiBOcG1Mb2NrRmlsZVJlYWRlciBpcyBhbiBhYnN0cmFjdGlvbiBhcm91bmQgdGhlIGxvZ2ljIHVzZWQgdG8gcmVhZCBhbmQgcGFyc2UgbG9jayBmaWxlIGNvbnRlbnRzXG4gKi9cbmV4cG9ydCBjbGFzcyBOcG1Mb2NrRmlsZVJlYWRlciBpbXBsZW1lbnRzIExvY2tGaWxlUmVhZGVyIHtcbiAgZ2V0TG9ja0ZpbGVDb250ZW50c0Zyb21Dd2QgPSBhc3luYyAoKTogUHJvbWlzZTxcbiAgICBMb2NrRmlsZUNvbnRlbnRzIHwgdW5kZWZpbmVkXG4gID4gPT4ge1xuICAgIGNvbnN0IGRlcGVuZGVuY2llczogQXJyYXk8RGVwZW5kZW5jeT4gPSBbXTtcbiAgICBjb25zdCBwYWNrYWdlTG9ja0pzb25QYXRoID0gcGF0aC5yZXNvbHZlKFxuICAgICAgcHJvY2Vzcy5jd2QoKSxcbiAgICAgICdwYWNrYWdlLWxvY2suanNvbicsXG4gICAgKTtcbiAgICBsZXQgcGFja2FnZUxvY2tKc29uO1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBqc29uTG9ja0NvbnRlbnRzID0gYXdhaXQgZnNwLnJlYWRGaWxlKHBhY2thZ2VMb2NrSnNvblBhdGgsICd1dGYtOCcpO1xuICAgICAgY29uc3QganNvbkxvY2tQYXJzZWRWYWx1ZSA9IEpTT04ucGFyc2UoanNvbkxvY2tDb250ZW50cyk7XG4gICAgICAvLyBUaGlzIHdpbGwgc3RyaXAgZmllbGRzIHRoYXQgYXJlIG5vdCBwYXJ0IG9mIHRoZSBwYWNrYWdlIGxvY2sgc2NoZW1hXG4gICAgICBwYWNrYWdlTG9ja0pzb24gPSBwYWNrYWdlTG9ja0pzb25TY2hlbWEucGFyc2UoanNvbkxvY2tQYXJzZWRWYWx1ZSk7XG4gICAgfSBjYXRjaCB7XG4gICAgICBwcmludGVyLmxvZyhcbiAgICAgICAgYEZhaWxlZCB0byBnZXQgbG9jayBmaWxlIGNvbnRlbnRzIGJlY2F1c2UgJHtwYWNrYWdlTG9ja0pzb25QYXRofSBkb2VzIG5vdCBleGlzdCBvciBpcyBub3QgcGFyc2UtYWJsZWAsXG4gICAgICAgIExvZ0xldmVsLkRFQlVHLFxuICAgICAgKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBmb3IgKGNvbnN0IGtleSBpbiBwYWNrYWdlTG9ja0pzb24ucGFja2FnZXMpIHtcbiAgICAgIGlmIChrZXkgPT09ICcnKSB7XG4gICAgICAgIC8vIFNraXAgcm9vdCBwcm9qZWN0IGluIHBhY2thZ2VzXG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgICAgY29uc3QgZGVwZW5kZW5jeVZlcnNpb24gPSBwYWNrYWdlTG9ja0pzb24ucGFja2FnZXNba2V5XS52ZXJzaW9uO1xuXG4gICAgICAvLyBWZXJzaW9uIG1heSBub3QgZXhpc3QgaWYgcGFja2FnZSBpcyBhIHN5bWJvbGljIGxpbmtcbiAgICAgIGlmIChkZXBlbmRlbmN5VmVyc2lvbikge1xuICAgICAgICAvLyBSZW1vdmUgXCJub2RlX21vZHVsZXMvXCIgcHJlZml4XG4gICAgICAgIGNvbnN0IGRlcGVuZGVuY3lOYW1lID0ga2V5LnJlcGxhY2UoL15ub2RlX21vZHVsZXNcXC8vLCAnJyk7XG4gICAgICAgIGRlcGVuZGVuY2llcy5wdXNoKHtcbiAgICAgICAgICBuYW1lOiBkZXBlbmRlbmN5TmFtZSxcbiAgICAgICAgICB2ZXJzaW9uOiBkZXBlbmRlbmN5VmVyc2lvbixcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHsgZGVwZW5kZW5jaWVzIH07XG4gIH07XG59XG5cbmNvbnN0IHBhY2thZ2VMb2NrSnNvblNjaGVtYSA9IHoub2JqZWN0KHtcbiAgcGFja2FnZXM6IHpcbiAgICAucmVjb3JkKFxuICAgICAgei5zdHJpbmcoKSxcbiAgICAgIHoub2JqZWN0KHtcbiAgICAgICAgdmVyc2lvbjogei5zdHJpbmcoKS5vcHRpb25hbCgpLFxuICAgICAgfSksXG4gICAgKVxuICAgIC5vcHRpb25hbCgpLFxufSk7XG4iXX0=