import { EOL } from 'os';
import ora, { oraPromise } from 'ora';
/**
 * The class that pretty prints to the output stream.
 */
export class Printer {
    minimumLogLevel;
    stdout;
    stderr;
    refreshRate;
    enableTTY;
    currentSpinners = {};
    /**
     * Sets default configs
     */
    constructor(minimumLogLevel, stdout = process.stdout, stderr = process.stderr, refreshRate = 500, enableTTY = process.env.CI ? false : true) {
        this.minimumLogLevel = minimumLogLevel;
        this.stdout = stdout;
        this.stderr = stderr;
        this.refreshRate = refreshRate;
        this.enableTTY = enableTTY;
    }
    /**
     * Prints a given message to output stream followed by a newline.
     */
    print = (message) => {
        this.stdout.write(message);
        this.printNewLine();
    };
    /**
     * Prints a new line to output stream
     */
    printNewLine = () => {
        this.stdout.write(EOL);
    };
    /**
     * Logs a message to the output stream at the given log level followed by a newline
     */
    log = (message, level = LogLevel.INFO) => {
        const doLogMessage = level <= this.minimumLogLevel;
        if (!doLogMessage) {
            return;
        }
        const logMessage = this.minimumLogLevel === LogLevel.DEBUG
            ? `[${LogLevel[level]}] ${new Date().toISOString()}: ${message}`
            : message;
        if (level === LogLevel.ERROR) {
            this.stderr.write(logMessage);
        }
        else {
            this.stdout.write(logMessage);
        }
        this.printNewLine();
    };
    /**
     * Logs a message with animated spinner
     * If stdout is not a TTY, the message is logged at the info level without a spinner
     */
    indicateProgress = async (message, callback, successMessage) => {
        await oraPromise(callback, {
            text: message,
            color: 'white',
            stream: this.stdout,
            discardStdin: false,
            hideCursor: false,
            interval: this.refreshRate,
            spinner: 'dots',
            successText: successMessage,
            isEnabled: this.enableTTY,
        });
    };
    /**
     * Start a spinner for the given message.
     * If stdout is not a TTY, the message is logged at the info level without a spinner
     * @returns the id of the spinner
     */
    startSpinner = (id, message, options = { timeoutSeconds: 60 }) => {
        this.currentSpinners[id] = {
            instance: ora({
                text: message,
                color: 'white',
                stream: this.stdout,
                spinner: 'dots',
                interval: this.refreshRate,
                discardStdin: false,
                hideCursor: false,
                isEnabled: this.enableTTY,
            }).start(),
            timeout: setTimeout(() => {
                this.stopSpinner(id);
            }, options.timeoutSeconds * 1000),
        };
        return id;
    };
    isSpinnerRunning = (id) => {
        return this.currentSpinners[id] !== undefined;
    };
    /**
     * Stop a spinner for the given id.
     */
    stopSpinner = (id) => {
        if (this.currentSpinners[id] === undefined)
            return;
        this.currentSpinners[id].instance.stop();
        clearTimeout(this.currentSpinners[id].timeout);
        delete this.currentSpinners[id];
    };
    /**
     * Update the spinner options for a given id, e.g. message or prefixText
     */
    updateSpinner = (id, options) => {
        if (this.currentSpinners[id] === undefined) {
            this.log(`Spinner with id ${id} not found or already stopped`, LogLevel.ERROR);
            return;
        }
        if (options.prefixText) {
            this.currentSpinners[id].instance.prefixText = options.prefixText;
        }
        else if (options.message) {
            this.currentSpinners[id].instance.text = options.message;
        }
        // Refresh the timer
        this.currentSpinners[id].timeout.refresh();
    };
}
export var LogLevel;
(function (LogLevel) {
    LogLevel[LogLevel["ERROR"] = 0] = "ERROR";
    LogLevel[LogLevel["INFO"] = 1] = "INFO";
    LogLevel[LogLevel["DEBUG"] = 2] = "DEBUG";
})(LogLevel || (LogLevel = {}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJpbnRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9wcmludGVyL3ByaW50ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLElBQUksQ0FBQztBQUN6QixPQUFPLEdBQUcsRUFBRSxFQUFPLFVBQVUsRUFBRSxNQUFNLEtBQUssQ0FBQztBQUkzQzs7R0FFRztBQUNILE1BQU0sT0FBTyxPQUFPO0lBUUM7SUFDQTtJQUdBO0lBR0E7SUFDQTtJQWZYLGVBQWUsR0FFbkIsRUFBRSxDQUFDO0lBQ1A7O09BRUc7SUFDSCxZQUNtQixlQUF5QixFQUN6QixTQUVXLE9BQU8sQ0FBQyxNQUFNLEVBQ3pCLFNBRVcsT0FBTyxDQUFDLE1BQU0sRUFDekIsY0FBc0IsR0FBRyxFQUN6QixZQUFZLE9BQU8sQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLElBQUk7UUFSekMsb0JBQWUsR0FBZixlQUFlLENBQVU7UUFDekIsV0FBTSxHQUFOLE1BQU0sQ0FFbUI7UUFDekIsV0FBTSxHQUFOLE1BQU0sQ0FFbUI7UUFDekIsZ0JBQVcsR0FBWCxXQUFXLENBQWM7UUFDekIsY0FBUyxHQUFULFNBQVMsQ0FBZ0M7SUFDekQsQ0FBQztJQUVKOztPQUVHO0lBQ0gsS0FBSyxHQUFHLENBQUMsT0FBZSxFQUFFLEVBQUU7UUFDMUIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDM0IsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO0lBQ3RCLENBQUMsQ0FBQztJQUVGOztPQUVHO0lBQ0gsWUFBWSxHQUFHLEdBQUcsRUFBRTtRQUNsQixJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUN6QixDQUFDLENBQUM7SUFFRjs7T0FFRztJQUNILEdBQUcsR0FBRyxDQUFDLE9BQWUsRUFBRSxRQUFr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QUFDO0lBQ2xDLENBQUMsQ0FBQztJQUVGOztPQUVHO0lBQ0gsYUFBYSxHQUFHLENBQ2QsRUFBVSxFQUNWLE9BQWtELEVBQzVDLEVBQUU7UUFDUixJQUFJLElBQUksQ0FBQyxlQUFlLENBQUMsRUFBRSxDQUFDLEtBQUssU0FBUyxFQUFFO1lBQzFDLElBQUksQ0FBQyxHQUFHLENBQ04sbUJBQW1CLEVBQUUsK0JBQStCLEVBQ3BELFFBQVEsQ0FBQyxLQUFLLENBQ2YsQ0FBQztZQUNGLE9BQU87U0FDUjtRQUNELElBQUksT0FBTyxDQUFDLFVBQVUsRUFBRTtZQUN0QixJQUFJLENBQUMsZUFBZSxDQUFDLEVBQUUsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxVQUFVLEdBQUcsT0FBTyxDQUFDLFVBQVUsQ0FBQztTQUNuRTthQUFNLElBQUksT0FBTyxDQUFDLE9BQU8sRUFBRTtZQUMxQixJQUFJLENBQUMsZUFBZSxDQUFDLEVBQUUsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxJQUFJLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQztTQUMxRDtRQUNELG9CQUFvQjtRQUNwQixJQUFJLENBQUMsZUFBZSxDQUFDLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsQ0FBQztJQUM3QyxDQUFDLENBQUM7Q0FDSDtBQUVELE1BQU0sQ0FBTixJQUFZLFFBSVg7QUFKRCxXQUFZLFFBQVE7SUFDbEIseUNBQVMsQ0FBQTtJQUNULHVDQUFRLENBQUE7SUFDUix5Q0FBUyxDQUFBO0FBQ1gsQ0FBQyxFQUpXLFFBQVEsS0FBUixRQUFRLFFBSW5CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgV3JpdGVTdHJlYW0gfSBmcm9tICdub2RlOnR0eSc7XG5pbXBvcnQgeyBFT0wgfSBmcm9tICdvcyc7XG5pbXBvcnQgb3JhLCB7IE9yYSwgb3JhUHJvbWlzZSB9IGZyb20gJ29yYSc7XG5cbmV4cG9ydCB0eXBlIFJlY29yZFZhbHVlID0gc3RyaW5nIHwgbnVtYmVyIHwgc3RyaW5nW10gfCBEYXRlO1xuXG4vKipcbiAqIFRoZSBjbGFzcyB0aGF0IHByZXR0eSBwcmludHMgdG8gdGhlIG91dHB1dCBzdHJlYW0uXG4gKi9cbmV4cG9ydCBjbGFzcyBQcmludGVyIHtcbiAgcHJpdmF0ZSBjdXJyZW50U3Bpbm5lcnM6IHtcbiAgICBbaWQ6IHN0cmluZ106IHsgaW5zdGFuY2U6IE9yYTsgdGltZW91dDogTm9kZUpTLlRpbWVvdXQgfTtcbiAgfSA9IHt9O1xuICAvKipcbiAgICogU2V0cyBkZWZhdWx0IGNvbmZpZ3NcbiAgICovXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgbWluaW11bUxvZ0xldmVsOiBMb2dMZXZlbCxcbiAgICBwcml2YXRlIHJlYWRvbmx5IHN0ZG91dDpcbiAgICAgIHwgV3JpdGVTdHJlYW1cbiAgICAgIHwgTm9kZUpTLldyaXRhYmxlU3RyZWFtID0gcHJvY2Vzcy5zdGRvdXQsXG4gICAgcHJpdmF0ZSByZWFkb25seSBzdGRlcnI6XG4gICAgICB8IFdyaXRlU3RyZWFtXG4gICAgICB8IE5vZGVKUy5Xcml0YWJsZVN0cmVhbSA9IHByb2Nlc3Muc3RkZXJyLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgcmVmcmVzaFJhdGU6IG51bWJlciA9IDUwMCxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGVuYWJsZVRUWSA9IHByb2Nlc3MuZW52LkNJID8gZmFsc2UgOiB0cnVlLFxuICApIHt9XG5cbiAgLyoqXG4gICAqIFByaW50cyBhIGdpdmVuIG1lc3NhZ2UgdG8gb3V0cHV0IHN0cmVhbSBmb2xsb3dlZCBieSBhIG5ld2xpbmUuXG4gICAqL1xuICBwcmludCA9IChtZXNzYWdlOiBzdHJpbmcpID0+IHtcbiAgICB0aGlzLnN0ZG91dC53cml0ZShtZXNzYWdlKTtcbiAgICB0aGlzLnByaW50TmV3TGluZSgpO1xuICB9O1xuXG4gIC8qKlxuICAgKiBQcmludHMgYSBuZXcgbGluZSB0byBvdXRwdXQgc3RyZWFtXG4gICAqL1xuICBwcmludE5ld0xpbmUgPSAoKSA9PiB7XG4gICAgdGhpcy5zdGRvdXQud3JpdGUoRU9MKTtcbiAgfTtcblxuICAvKipcbiAgICogTG9ncyBhIG1lc3NhZ2UgdG8gdGhlIG91dHB1dCBzdHJlYW0gYXQgdGhlIGdpdmVuIGxvZyBsZXZlbCBmb2xsb3dlZCBieSBhIG5ld2xpbmVcbiAgICovXG4gIGxvZyA9IChtZXNzYWdlOiBzdHJpbmcsIGxldmVsOiBMb2dMZXZlbCA9IExvZ0xldmVsLklORk8pID0+IHtcbiAgICBjb25zdCBkb0xvZ01lc3NhZ2UgPSBsZXZlbCA8PSB0aGlzLm1pbmltdW1Mb2dMZXZlbDtcblxuICAgIGlmICghZG9Mb2dNZXNzYWdlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgbG9nTWVzc2FnZSA9XG4gICAgICB0aGlzLm1pbmltdW1Mb2dMZXZlbCA9PT0gTG9nTGV2ZWwuREVCVUdcbiAgICAgICAgPyBgWyR7TG9nTGV2ZWxbbGV2ZWxdfV0gJHtuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCl9OiAke21lc3NhZ2V9YFxuICAgICAgICA6IG1lc3NhZ2U7XG5cbiAgICBpZiAobGV2ZWwgPT09IExvZ0xldmVsLkVSUk9SKSB7XG4gICAgICB0aGlzLnN0ZGVyci53cml0ZShsb2dNZXNzYWdlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5zdGRvdXQud3JpdGUobG9nTWVzc2FnZSk7XG4gICAgfVxuXG4gICAgdGhpcy5wcmludE5ld0xpbmUoKTtcbiAgfTtcblxuICAvKipcbiAgICogTG9ncyBhIG1lc3NhZ2Ugd2l0aCBhbmltYXRlZCBzcGlubmVyXG4gICAqIElmIHN0ZG91dCBpcyBub3QgYSBUVFksIHRoZSBtZXNzYWdlIGlzIGxvZ2dlZCBhdCB0aGUgaW5mbyBsZXZlbCB3aXRob3V0IGEgc3Bpbm5lclxuICAgKi9cbiAgaW5kaWNhdGVQcm9ncmVzcyA9IGFzeW5jIChcbiAgICBtZXNzYWdlOiBzdHJpbmcsXG4gICAgY2FsbGJhY2s6ICgpID0+IFByb21pc2U8dm9pZD4sXG4gICAgc3VjY2Vzc01lc3NhZ2U/OiBzdHJpbmcsXG4gICkgPT4ge1xuICAgIGF3YWl0IG9yYVByb21pc2UoY2FsbGJhY2ssIHtcbiAgICAgIHRleHQ6IG1lc3NhZ2UsXG4gICAgICBjb2xvcjogJ3doaXRlJyxcbiAgICAgIHN0cmVhbTogdGhpcy5zdGRvdXQsXG4gICAgICBkaXNjYXJkU3RkaW46IGZhbHNlLFxuICAgICAgaGlkZUN1cnNvcjogZmFsc2UsXG4gICAgICBpbnRlcnZhbDogdGhpcy5yZWZyZXNoUmF0ZSxcbiAgICAgIHNwaW5uZXI6ICdkb3RzJyxcbiAgICAgIHN1Y2Nlc3NUZXh0OiBzdWNjZXNzTWVzc2FnZSxcbiAgICAgIGlzRW5hYmxlZDogdGhpcy5lbmFibGVUVFksXG4gICAgfSk7XG4gIH07XG5cbiAgLyoqXG4gICAqIFN0YXJ0IGEgc3Bpbm5lciBmb3IgdGhlIGdpdmVuIG1lc3NhZ2UuXG4gICAqIElmIHN0ZG91dCBpcyBub3QgYSBUVFksIHRoZSBtZXNzYWdlIGlzIGxvZ2dlZCBhdCB0aGUgaW5mbyBsZXZlbCB3aXRob3V0IGEgc3Bpbm5lclxuICAgKiBAcmV0dXJucyB0aGUgaWQgb2YgdGhlIHNwaW5uZXJcbiAgICovXG4gIHN0YXJ0U3Bpbm5lciA9IChcbiAgICBpZDogc3RyaW5nLFxuICAgIG1lc3NhZ2U6IHN0cmluZyxcbiAgICBvcHRpb25zOiB7IHRpbWVvdXRTZWNvbmRzOiBudW1iZXIgfSA9IHsgdGltZW91dFNlY29uZHM6IDYwIH0sXG4gICk6IHN0cmluZyA9PiB7XG4gICAgdGhpcy5jdXJyZW50U3Bpbm5lcnNbaWRdID0ge1xuICAgICAgaW5zdGFuY2U6IG9yYSh7XG4gICAgICAgIHRleHQ6IG1lc3NhZ2UsXG4gICAgICAgIGNvbG9yOiAnd2hpdGUnLFxuICAgICAgICBzdHJlYW06IHRoaXMuc3Rkb3V0LFxuICAgICAgICBzcGlubmVyOiAnZG90cycsXG4gICAgICAgIGludGVydmFsOiB0aGlzLnJlZnJlc2hSYXRlLFxuICAgICAgICBkaXNjYXJkU3RkaW46IGZhbHNlLFxuICAgICAgICBoaWRlQ3Vyc29yOiBmYWxzZSxcbiAgICAgICAgaXNFbmFibGVkOiB0aGlzLmVuYWJsZVRUWSxcbiAgICAgIH0pLnN0YXJ0KCksXG4gICAgICB0aW1lb3V0OiBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgdGhpcy5zdG9wU3Bpbm5lcihpZCk7XG4gICAgICB9LCBvcHRpb25zLnRpbWVvdXRTZWNvbmRzICogMTAwMCksXG4gICAgfTtcbiAgICByZXR1cm4gaWQ7XG4gIH07XG5cbiAgaXNTcGlubmVyUnVubmluZyA9IChpZDogc3RyaW5nKTogYm9vbGVhbiA9PiB7XG4gICAgcmV0dXJuIHRoaXMuY3VycmVudFNwaW5uZXJzW2lkXSAhPT0gdW5kZWZpbmVkO1xuICB9O1xuXG4gIC8qKlxuICAgKiBTdG9wIGEgc3Bpbm5lciBmb3IgdGhlIGdpdmVuIGlkLlxuICAgKi9cbiAgc3RvcFNwaW5uZXIgPSAoaWQ6IHN0cmluZyk6IHZvaWQgPT4ge1xuICAgIGlmICh0aGlzLmN1cnJlbnRTcGlubmVyc1tpZF0gPT09IHVuZGVmaW5lZCkgcmV0dXJuO1xuICAgIHRoaXMuY3VycmVudFNwaW5uZXJzW2lkXS5pbnN0YW5jZS5zdG9wKCk7XG4gICAgY2xlYXJUaW1lb3V0KHRoaXMuY3VycmVudFNwaW5uZXJzW2lkXS50aW1lb3V0KTtcbiAgICBkZWxldGUgdGhpcy5jdXJyZW50U3Bpbm5lcnNbaWRdO1xuICB9O1xuXG4gIC8qKlxuICAgKiBVcGRhdGUgdGhlIHNwaW5uZXIgb3B0aW9ucyBmb3IgYSBnaXZlbiBpZCwgZS5nLiBtZXNzYWdlIG9yIHByZWZpeFRleHRcbiAgICovXG4gIHVwZGF0ZVNwaW5uZXIgPSAoXG4gICAgaWQ6IHN0cmluZyxcbiAgICBvcHRpb25zOiB7IG1lc3NhZ2U/OiBzdHJpbmc7IHByZWZpeFRleHQ/OiBzdHJpbmcgfSxcbiAgKTogdm9pZCA9PiB7XG4gICAgaWYgKHRoaXMuY3VycmVudFNwaW5uZXJzW2lkXSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICB0aGlzLmxvZyhcbiAgICAgICAgYFNwaW5uZXIgd2l0aCBpZCAke2lkfSBub3QgZm91bmQgb3IgYWxyZWFkeSBzdG9wcGVkYCxcbiAgICAgICAgTG9nTGV2ZWwuRVJST1IsXG4gICAgICApO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAob3B0aW9ucy5wcmVmaXhUZXh0KSB7XG4gICAgICB0aGlzLmN1cnJlbnRTcGlubmVyc1tpZF0uaW5zdGFuY2UucHJlZml4VGV4dCA9IG9wdGlvbnMucHJlZml4VGV4dDtcbiAgICB9IGVsc2UgaWYgKG9wdGlvbnMubWVzc2FnZSkge1xuICAgICAgdGhpcy5jdXJyZW50U3Bpbm5lcnNbaWRdLmluc3RhbmNlLnRleHQgPSBvcHRpb25zLm1lc3NhZ2U7XG4gICAgfVxuICAgIC8vIFJlZnJlc2ggdGhlIHRpbWVyXG4gICAgdGhpcy5jdXJyZW50U3Bpbm5lcnNbaWRdLnRpbWVvdXQucmVmcmVzaCgpO1xuICB9O1xufVxuXG5leHBvcnQgZW51bSBMb2dMZXZlbCB7XG4gIEVSUk9SID0gMCxcbiAgSU5GTyA9IDEsXG4gIERFQlVHID0gMixcbn1cbiJdfQ==